generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////////////////////////////////////
// ENUMS
///////////////////////////////////////////////////////////////

enum UserRole {
  OWNER // Phase 8: Salon owner (can manage subscription & staff)
  ADMIN
  MANAGER
  RECEPTIONIST
  STYLIST
  ASSISTANT
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELLED
  EXPIRED
  SUSPENDED
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
}

enum CommissionType {
  SERVICE
  RETAIL
}

enum SalaryStatus {
  PENDING
  PAID
}

enum LoyaltyTierName {
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum NotificationStatus {
  UNREAD
  READ
}

enum CustomerJourneyState {
  AWARENESS
  CONSIDERATION
  BOOKING
  IN_SALON
  POST_SERVICE
  RETENTION
}

///////////////////////////////////////////////////////////////
// SALON (Multi-Tenant)
///////////////////////////////////////////////////////////////

model Salon {
  id                  String             @id @default(cuid())
  name                String
  slug                String             @unique
  status              String             @default("ACTIVE") // ACTIVE, INACTIVE, SUSPENDED
  // Phase 8: Subscription fields
  planId              String?
  planStatus          SubscriptionStatus @default(TRIAL)
  trialEndsAt         DateTime?
  currentPeriodEndsAt DateTime?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  plan          Plan?           @relation(fields: [planId], references: [id])
  users         User[]
  customers     Customer[]
  bookings      Booking[]
  invoices      Invoice[]
  services      Service[]
  products      Product[]
  subscription  Subscription?
  usageTracking UsageTracking[]

  @@index([slug])
  @@index([status])
  @@index([planId])
  @@index([planStatus])
}

///////////////////////////////////////////////////////////////
// BRANCH
///////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////
// USER (STAFF)
///////////////////////////////////////////////////////////////

model User {
  id           String   @id @default(uuid())
  partnerId    String? // Phase 27: Partner isolation
  salonId      String // Multi-tenant: Salon isolation
  name         String
  trainingRole String? // RECEPTIONIST | STYLIST | ASSISTANT | CSKH_ONLINE
  currentLevel Int? // Current training level (1-4)
  phone        String   @unique
  password     String
  role         UserRole
  branchId     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  salon               Salon                   @relation(fields: [salonId], references: [id], onDelete: Cascade)
  partner             Partner?                @relation("PartnerUsers", fields: [partnerId], references: [id], onDelete: Cascade)
  branch              Branch?                 @relation("BranchUsers", fields: [branchId], references: [id])
  bookings            Booking[]               @relation("StylistBookings")
  salaryProfiles      StaffSalaryProfile[]
  dailyRecords        StaffDailyRecord[]
  commissions         CommissionRecord[]
  kpiSummaries        KPISummary[]
  salaryPayouts       SalaryPayout[]
  notifications       Notification[]
  quizResults         TrainingQuizResult[]
  simulationSessions  SimulationSession[]
  skillProgress       SkillProgress[]
  trainingProgress    TrainingProgress[]
  exerciseSubmissions ExerciseSubmission[]
  roleplaySessions    RoleplaySession[]
  certifications      Certification[]
  operationLogs       OperationLog[]
  stockIssues         StockIssue[]            @relation("IssueStaff")
  staffAssessments    SkillAssessment[]       @relation("StaffAssessments")
  stockLogsCreated    StockLog[]              @relation("StockLogCreator")
  mixLogs             MixLog[]                @relation("MixLogStaff")
  lossAlerts          LossAlert[]             @relation("LossAlertStaff") // Phase 19I
  consumptionTopStaff ConsumptionTracking[]   @relation("ConsumptionTopStaff") // Phase 19J
  touchpoints         CustomerTouchpoint[]    @relation("TouchpointStaff") // Phase 20
  signatureStyle      StylistSignatureStyle?
  branchAssignments   BranchStaffAssignment[] @relation("StaffBranchAssignment")
  staff               Staff?                  @relation("UserStaff")

  @@index([salonId])
  @@index([phone])
}

///////////////////////////////////////////////////////////////
// STAFF (Nhân viên)
///////////////////////////////////////////////////////////////

model Staff {
  id             String    @id @default(uuid())
  userId         String    @unique // Link to User
  employeeId     String?   @unique // Mã nhân viên
  position       String? // Vị trí: Stylist, Assistant, Receptionist, etc.
  hireDate       DateTime? // Ngày vào làm
  salary         Float? // Lương cơ bản
  commissionRate Float? // Tỷ lệ hoa hồng (%)
  specialization String? // Chuyên môn
  isActive       Boolean   @default(true) // Trạng thái hoạt động
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user          User           @relation("UserStaff", fields: [userId], references: [id], onDelete: Cascade)
  staffServices StaffService[] // Dịch vụ nhân viên có thể làm
  shifts        StaffShift[] // Ca làm việc

  @@index([userId])
  @@index([employeeId])
  @@index([position])
  @@index([isActive])
}

model StaffService {
  id        String @id @default(uuid())
  staffId   String
  serviceId String

  staff   Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([staffId, serviceId])
  @@index([staffId])
  @@index([serviceId])
}

model StaffShift {
  id        String   @id @default(uuid())
  staffId   String
  date      DateTime
  startTime String? // HH:mm format
  endTime   String? // HH:mm format
  notes     String?

  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([date])
}

///////////////////////////////////////////////////////////////
// CUSTOMER
///////////////////////////////////////////////////////////////

model Customer {
  id               String               @id @default(uuid())
  salonId          String // Multi-tenant: Salon isolation
  name             String
  phone            String               @unique
  birthday         DateTime?
  gender           String?
  avatar           String? // ảnh đại diện
  notes            String? // ghi chú tổng hợp
  riskLevel        String? // LOW | MEDIUM | HIGH
  preferredStylist String? // Stylist yêu thích
  totalSpent       Int                  @default(0) // Tổng chi tiêu (tính từ invoices)
  totalVisits      Int                  @default(0) // Tổng số lần đến (tính từ visits)
  journeyState     CustomerJourneyState @default(AWARENESS)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  salon                 Salon                       @relation(fields: [salonId], references: [id], onDelete: Cascade)
  bookings              Booking[]
  invoices              Invoice[]
  loyalty               CustomerLoyalty?
  points                LoyaltyPoint[]
  marketingLogs         MarketingLog[]
  profile               CustomerProfile?
  photos                CustomerPhoto[] // Customer photos
  followUps             FollowUpMessage[]
  operationLogs         OperationLog[]
  visits                Visit[] // Timeline visits
  tags                  CustomerTag[] // CRM Tags
  reminders             Reminder[] // Reminders
  insights              CustomerInsight[] // AI Insights
  journeys              CustomerJourney[]           @relation("CustomerJourneyCustomer") // Phase 20
  touchpoints           CustomerTouchpoint[]        @relation("CustomerTouchpointCustomer") // Phase 20
  experiences           CustomerExperience[]        @relation("CustomerExperienceCustomer") // Phase 20
  behavior              CustomerBehavior?           @relation("CustomerBehaviorCustomer") // Phase 20
  riskAlerts            CustomerRiskAlert[]         @relation("CustomerRiskAlertCustomer") // Phase 20
  predictions           CustomerPrediction[]        @relation("CustomerPredictionCustomer") // Phase 20
  upsaleRecommendations UpsaleRecommendation[]      @relation("CustomerUpsaleRecommendation") // Phase 22
  upsaleRecords         UpsaleRecord[]              @relation("CustomerUpsaleRecord") // Phase 22
  personalityProfile    CustomerPersonalityProfile?
  membership            CustomerMembership?

  @@index([salonId])
  @@index([phone])
}

///////////////////////////////////////////////////////////////
// BOOKING
///////////////////////////////////////////////////////////////

model Booking {
  id         String   @id @default(uuid())
  salonId    String // Multi-tenant: Salon isolation
  customerId String
  branchId   String
  stylistId  String?
  serviceId  String?
  date       DateTime
  status     String
  notes      String?

  salon    Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id])
  branch   Branch   @relation("BranchBooking", fields: [branchId], references: [id])
  stylist  User?    @relation("StylistBookings", fields: [stylistId], references: [id])
  service  Service? @relation(fields: [serviceId], references: [id])

  invoice Invoice?

  @@index([salonId])
  @@index([customerId])
  @@index([stylistId])
  @@index([date])
}

///////////////////////////////////////////////////////////////
// SERVICE & PRODUCT
///////////////////////////////////////////////////////////////

model Service {
  id                 String  @id @default(uuid())
  salonId            String // Multi-tenant: Salon isolation
  name               String
  code               String? // Mã dịch vụ
  category           String // Nhóm dịch vụ
  description        String? // Mô tả
  englishName        String? // Tên tiếng Anh
  englishDescription String? // Mô tả bằng tiếng Anh
  price              Int
  duration           Int
  image              String? // URL hình ảnh
  isActive           Boolean @default(true)
  allowPriceOverride Boolean @default(false) // Sửa giá khi thanh toán
  unit               String? // Đơn vị tính (lần, giờ, ngày, gói, etc.)
  displayLocation    String? // Tùy chọn hiển thị: POS, BOOKING, BOTH, NONE

  salon             Salon                 @relation(fields: [salonId], references: [id], onDelete: Cascade)
  bookings          Booking[]
  invoiceItems      InvoiceItem[]
  commissionRecords CommissionRecord[]
  usage             ServiceProductUsage[]
  serviceCosts      ServiceCost[] // Phase 19H
  staffServices     StaffService[]

  @@index([salonId])
  @@index([code])
  @@index([category])
  @@index([isActive])
}

model Product {
  id           String  @id @default(uuid())
  salonId      String // Multi-tenant: Salon isolation
  name         String
  sku          String? @unique // Mã SKU (tự động sinh nếu không có)
  category     String
  subCategory  String? // Uốn nóng | Uốn lạnh | Treatment | etc.
  unit         String // Đơn vị đếm (Ống, Chai, Túi, Cái, etc.)
  capacity     Float? // Dung tích/số lượng (15, 100, etc.)
  capacityUnit String? // Đơn vị dung tích (ml, l, g, kg, etc.)
  defaultUsage Int?
  branchAware  Boolean @default(true)

  // Phase 19 fields
  pricePerUnit Float? // Giá bán mỗi đơn vị
  costPrice    Float? // Giá vốn mỗi đơn vị
  stock        Float?    @default(0) // Tồn kho tổng (nếu không branch-aware)
  minStock     Float? // Tồn kho tối thiểu (cảnh báo)
  maxStock     Float? // Tồn kho tối đa
  supplierId   String? // ID nhà cung cấp
  expiryDate   DateTime? // Hạn sử dụng
  imageUrl     String? // Ảnh sản phẩm
  isActive     Boolean   @default(true) // Trạng thái: Sẵn sàng/Ngừng kinh doanh
  notes        String? // Ghi chú

  invoiceItems           InvoiceItem[]
  stocks                 ProductStock[]
  stockTransactions      StockTransaction[]
  commissionRecords      CommissionRecord[]
  usage                  ServiceProductUsage[]
  stockLogs              StockLog[] // Phase 19
  mixLogs                MixLog[] // Phase 19
  lossAlerts             LossAlert[]             @relation("LossAlertProduct") // Phase 19I
  consumption            ConsumptionTracking[]   @relation("ConsumptionProduct") // Phase 19J
  projections            InventoryProjection[]   @relation("ProjectionProduct") // Phase 19J
  restockRecommendations RestockRecommendation[] @relation("RestockProduct") // Phase 19J
  restockTriggers        RestockTrigger[]        @relation("RestockTriggerProduct") // Phase 19J
  branchInventories      BranchInventory[]       @relation("BranchInventoryProduct")
  serviceCosts           ServiceCost[]
  salon                  Salon                   @relation(fields: [salonId], references: [id], onDelete: Cascade)
  supplier               Supplier?               @relation(fields: [supplierId], references: [id])
  stockTransferItems     StockTransferItem[]
  receiptItems           StockReceiptItem[]      @relation("ReceiptProduct")
  issueItems             StockIssueItem[]        @relation("IssueProduct")

  @@index([salonId])
  @@index([category])
  @@index([name])
  @@index([sku])
  @@index([supplierId])
  @@index([isActive])
}

///////////////////////////////////////////////////////////////
// POS — INVOICE
///////////////////////////////////////////////////////////////

model Invoice {
  id         String   @id @default(uuid())
  salonId    String // Multi-tenant: Salon isolation
  customerId String
  branchId   String
  bookingId  String?  @unique
  date       DateTime @default(now())
  total      Int

  salon    Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id])
  branch   Branch   @relation("BranchInvoice", fields: [branchId], references: [id])
  booking  Booking? @relation(fields: [bookingId], references: [id])

  items         InvoiceItem[]
  commissions   CommissionRecord[]
  loyaltyPoints LoyaltyPoint[]

  @@index([salonId])
  @@index([customerId])
  @@index([date])
}

model InvoiceItem {
  id        String  @id @default(uuid())
  invoiceId String
  serviceId String?
  productId String?
  amount    Int

  invoice Invoice  @relation(fields: [invoiceId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])
  product Product? @relation(fields: [productId], references: [id])
}

///////////////////////////////////////////////////////////////
// INVENTORY (PHASE 9.1)
///////////////////////////////////////////////////////////////

model ProductStock {
  id         String   @id @default(uuid())
  productId  String
  branchId   String
  locationId String? // Vị trí trong kho
  quantity   Int
  updatedAt  DateTime @updatedAt

  product  Product   @relation(fields: [productId], references: [id])
  branch   Branch    @relation(fields: [branchId], references: [id])
  location Location? @relation(fields: [locationId], references: [id])

  @@index([locationId])
}

model Location {
  id          String   @id @default(uuid())
  branchId    String
  code        String // Mã vị trí (ví dụ: A-01-02-03)
  zone        String? // Khu vực (ví dụ: Khu A, Khu B)
  rack        String? // Giá kệ (ví dụ: Rack 01)
  shelf       String? // Kệ (ví dụ: Shelf 02)
  bin         String? // Ngăn/Vị trí (ví dụ: Bin 03)
  description String? // Mô tả
  isActive    Boolean  @default(true)
  capacity    Int? // Sức chứa (số sản phẩm)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch        Branch         @relation(fields: [branchId], references: [id])
  productStocks ProductStock[]

  @@unique([branchId, code])
  @@index([branchId])
  @@index([code])
}

model StockTransaction {
  id          String   @id @default(uuid())
  productId   String
  branchId    String
  type        String // IN | OUT | ADJUST | TRANSFER | MIX
  quantity    Int
  reason      String?
  referenceId String? // ID tham chiếu (transferId, receiptId, etc.)
  createdAt   DateTime @default(now())

  product Product @relation(fields: [productId], references: [id])
  branch  Branch  @relation(fields: [branchId], references: [id])

  @@index([type])
  @@index([createdAt])
}

model ServiceProductUsage {
  id        String @id @default(uuid())
  serviceId String
  productId String
  amount    Int

  service Service @relation(fields: [serviceId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

///////////////////////////////////////////////////////////////
// STOCK TRANSFER (Chuyển kho)
///////////////////////////////////////////////////////////////

model StockTransfer {
  id             String    @id @default(uuid())
  transferNumber String    @unique // Số phiếu (ví dụ: CK-2025-001)
  fromBranchId   String // Chi nhánh nguồn
  toBranchId     String // Chi nhánh đích
  date           DateTime  @default(now())
  status         String    @default("PENDING") // PENDING | IN_TRANSIT | COMPLETED | CANCELLED
  createdBy      String // User ID
  completedBy    String? // User ID người hoàn thành
  completedAt    DateTime?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  fromBranch Branch              @relation("TransferFrom", fields: [fromBranchId], references: [id])
  toBranch   Branch              @relation("TransferTo", fields: [toBranchId], references: [id])
  items      StockTransferItem[]

  @@index([fromBranchId])
  @@index([toBranchId])
  @@index([status])
  @@index([date])
}

model StockTransferItem {
  id         String  @id @default(uuid())
  transferId String
  productId  String
  quantity   Int
  costPrice  Float? // Giá vốn tại thời điểm chuyển
  notes      String?

  transfer StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product  Product       @relation(fields: [productId], references: [id])

  @@index([transferId])
  @@index([productId])
}

///////////////////////////////////////////////////////////////
// STOCK RECEIPT (Phiếu nhập kho)
///////////////////////////////////////////////////////////////

model StockReceipt {
  id              String    @id @default(uuid())
  receiptNumber   String    @unique // Số phiếu (ví dụ: PN-2025-001)
  branchId        String
  supplierId      String? // Nhà cung cấp
  date            DateTime  @default(now())
  status          String    @default("DRAFT") // DRAFT | APPROVED | COMPLETED | CANCELLED
  importType      String? // Phân loại nhập: NHAP_MUA_TU_NCC | NHAP_HANG_TRA_LAI | NHAP_DONG_GOI
  totalAmount     Float     @default(0)
  totalDiscount   Float     @default(0) // Giảm giá toàn bộ (số tiền)
  discountPercent Float?    @default(0) // Giảm giá toàn bộ (%)
  finalAmount     Float     @default(0) // Tổng tiền sau giảm giá
  createdBy       String // User ID
  approvedBy      String? // User ID người duyệt
  approvedAt      DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  branch   Branch             @relation("ReceiptBranch", fields: [branchId], references: [id])
  supplier Supplier?          @relation("ReceiptSupplier", fields: [supplierId], references: [id])
  items    StockReceiptItem[]

  @@index([branchId])
  @@index([supplierId])
  @@index([status])
  @@index([importType])
  @@index([date])
  @@index([receiptNumber])
}

model StockReceiptItem {
  id              String  @id @default(uuid())
  receiptId       String
  productId       String
  quantity        Int
  unitPrice       Float // Giá nhập đơn vị
  discountPercent Float?  @default(0) // Giảm giá % cho sản phẩm này
  discountAmount  Float?  @default(0) // Giảm giá số tiền cho sản phẩm này
  totalPrice      Float // Tổng giá = (quantity * unitPrice) - discountAmount
  notes           String?

  receipt StockReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  product Product      @relation("ReceiptProduct", fields: [productId], references: [id])

  @@index([receiptId])
  @@index([productId])
}

///////////////////////////////////////////////////////////////
// STOCK ISSUE (Phiếu xuất kho)
///////////////////////////////////////////////////////////////

model StockIssue {
  id            String    @id @default(uuid())
  issueNumber   String    @unique // Số phiếu (ví dụ: PX-2025-001)
  branchId      String
  reason        String // XUAT_TIEU_HAO | XUAT_DAO_TAO | XUAT_BAN_HOC_VIEN | XUAT_TRA_HANG_NCC | XUAT_HUY_HONG_HOC | XUAT_CHO_TANG | XUAT_DONG_GOI | XUAT_HANG_SVC | XUAT_KHAC | BAN_HANG | SU_DUNG | BAN_NHAN_VIEN
  recipientId   String? // Người nhận (User ID hoặc Customer ID)
  recipientName String? // Tên người nhận (nếu không có trong hệ thống)
  staffId       String? // Nhân viên (nếu xuất cho nhân viên)
  date          DateTime  @default(now())
  status        String    @default("DRAFT") // DRAFT | APPROVED | COMPLETED | CANCELLED
  totalAmount   Float     @default(0)
  createdBy     String // User ID
  approvedBy    String? // User ID người duyệt
  approvedAt    DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  branch Branch           @relation("IssueBranch", fields: [branchId], references: [id])
  staff  User?            @relation("IssueStaff", fields: [staffId], references: [id])
  items  StockIssueItem[]

  @@index([branchId])
  @@index([staffId])
  @@index([recipientId])
  @@index([reason])
  @@index([status])
  @@index([date])
  @@index([issueNumber])
}

model StockIssueItem {
  id         String  @id @default(uuid())
  issueId    String
  productId  String
  quantity   Int
  unitPrice  Float? // Giá xuất đơn vị (nếu có)
  totalPrice Float? // Tổng giá = quantity * unitPrice
  notes      String?

  issue   StockIssue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  product Product    @relation("IssueProduct", fields: [productId], references: [id])

  @@index([issueId])
  @@index([productId])
}

///////////////////////////////////////////////////////////////
// SUPPLIER MANAGEMENT
///////////////////////////////////////////////////////////////

model Supplier {
  id           String   @id @default(uuid())
  code         String // Mã nhà cung cấp (ví dụ: NCC001)
  name         String // Tên nhà cung cấp
  contactName  String? // Tên người liên hệ
  phone        String? // Số điện thoại
  email        String? // Email
  address      String? // Địa chỉ
  city         String? // Thành phố
  province     String? // Tỉnh/Thành phố
  country      String?  @default("VN") // Quốc gia
  taxCode      String? // Mã số thuế
  website      String? // Website
  paymentTerms String? // Điều khoản thanh toán (ví dụ: "Net 30")
  notes        String? // Ghi chú
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  products Product[]
  receipts StockReceipt[] @relation("ReceiptSupplier")

  @@unique([code])
  @@index([name])
  @@index([isActive])
}

///////////////////////////////////////////////////////////////
// LOYALTY (PHASE 5)
///////////////////////////////////////////////////////////////

model LoyaltyPoint {
  id          String   @id @default(uuid())
  customerId  String
  invoiceId   String?
  points      Int
  description String?
  createdAt   DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
  invoice  Invoice? @relation(fields: [invoiceId], references: [id])
}

model LoyaltyTier {
  id       String          @id @default(uuid())
  name     LoyaltyTierName
  minSpend Int
  discount Int
  perks    Json

  customers CustomerLoyalty[]
}

model CustomerLoyalty {
  id          String  @id @default(uuid())
  customerId  String  @unique
  tierId      String?
  totalPoints Int
  lifetimePts Int

  customer Customer     @relation(fields: [customerId], references: [id])
  tier     LoyaltyTier? @relation(fields: [tierId], references: [id])
}

///////////////////////////////////////////////////////////////
// SALARY SYSTEM (PHASE 9.2)
///////////////////////////////////////////////////////////////

model StaffSalaryProfile {
  id               String   @id @default(uuid())
  staffId          String
  baseSalary       Int
  commissionConfig Json
  kpiTargets       Json
  penalties        Json
  updatedAt        DateTime @updatedAt

  staff User @relation(fields: [staffId], references: [id])
}

model StaffDailyRecord {
  id       String           @id @default(uuid())
  staffId  String
  date     DateTime
  checkIn  DateTime?
  checkOut DateTime?
  status   AttendanceStatus
  notes    String?

  staff User @relation(fields: [staffId], references: [id])
}

model CommissionRecord {
  id        String   @id @default(uuid())
  staffId   String
  invoiceId String?
  serviceId String?
  productId String?
  amount    Int
  createdAt DateTime @default(now())

  staff   User     @relation(fields: [staffId], references: [id])
  invoice Invoice? @relation(fields: [invoiceId], references: [id])
  service Service? @relation(fields: [serviceId], references: [id])
  product Product? @relation(fields: [productId], references: [id])
}

model KPISummary {
  id           String @id @default(uuid())
  staffId      String
  month        String
  revenue      Int
  serviceCount Int
  productSales Int
  score        Int

  staff User @relation(fields: [staffId], references: [id])
}

model SalaryPayout {
  id          String   @id @default(uuid())
  staffId     String
  branchId    String
  month       String
  totalSalary Int
  breakdown   Json
  generatedAt DateTime @default(now())

  staff  User   @relation(fields: [staffId], references: [id])
  branch Branch @relation(fields: [branchId], references: [id])
}

///////////////////////////////////////////////////////////////
// NOTIFICATION
///////////////////////////////////////////////////////////////

model Notification {
  id        String             @id @default(uuid())
  userId    String
  title     String
  message   String
  status    NotificationStatus
  data      Json?
  createdAt DateTime           @default(now())

  user User @relation(fields: [userId], references: [id])
}

///////////////////////////////////////////////////////////////
// MARKETING (PHASE 7)
///////////////////////////////////////////////////////////////

model MarketingCampaign {
  id          String    @id @default(uuid())
  type        String
  name        String
  description String?
  segment     Json
  channel     String
  status      String
  scheduledAt DateTime?
  createdAt   DateTime  @default(now())

  logs        MarketingLog[]
  channels    MarketingChannel[]
  contents    MarketingContent[]
  automations MarketingAutomation[]
}

model MarketingLog {
  id         String   @id @default(uuid())
  campaignId String
  customerId String
  channel    String
  status     String
  createdAt  DateTime @default(now())

  campaign MarketingCampaign @relation(fields: [campaignId], references: [id])
  customer Customer          @relation(fields: [customerId], references: [id])
}

///////////////////////////////////////////////////////////////
// STYLIST COACH (PHASE 11)
///////////////////////////////////////////////////////////////

model StylistAnalysis {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  hairCondition   String
  hairHistory     String
  customerGoal    String
  curlType        String
  hairDamageLevel String
  stylistNote     String

  resultJson Json
}

///////////////////////////////////////////////////////////////
// AI WORKFLOW ENGINE (PHASE 12)
///////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////
// CUSTOMER PROFILE + MEMORY SYSTEM (PHASE 13C)
///////////////////////////////////////////////////////////////

model CustomerProfile {
  id         String   @id @default(cuid())
  customerId String   @unique
  name       String?
  phone      String?  @unique
  avatarUrl  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Customer Journey State
  journeyState String @default("AWARENESS")

  // Memory Fields (AI Memory Graph)
  preferences      Json? // Sở thích khách (kiểu tóc, style, giá...)
  hairHistory      Json? // Lịch sử hóa chất (tẩy, nhuộm, uốn...)
  technicalHistory Json? // Lịch sử kỹ thuật từ Stylist Coach
  bookingHistory   Json? // Lịch sử đặt lịch
  chatHistory      Json? // Tóm tắt hội thoại AI
  insight          Json? // AI phân tích hành vi

  // Relationship
  customer Customer @relation(fields: [customerId], references: [id])
}

///////////////////////////////////////////////////////////////
// CUSTOMER PHOTOS (CRM)
///////////////////////////////////////////////////////////////

model CustomerPhoto {
  id          String   @id @default(cuid())
  customerId  String
  imageUrl    String // URL của ảnh (có thể là local path hoặc cloud URL)
  description String? // Mô tả ảnh (optional)
  uploadedBy  String? // Người upload (staff name hoặc user ID)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([createdAt])
}

///////////////////////////////////////////////////////////////
// FOLLOW-UP SYSTEM (PHASE 13F)
///////////////////////////////////////////////////////////////

model FollowUpMessage {
  id           String    @id @default(cuid())
  customerId   String
  phone        String?
  ruleId       String
  messageType  String
  message      String
  scheduledFor DateTime
  sentAt       DateTime?
  status       String    @default("pending") // pending | sent | failed
  channel      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  customer Customer @relation(fields: [customerId], references: [id])
}

///////////////////////////////////////////////////////////////
// CONTENT LIBRARY (PHASE 14E)
///////////////////////////////////////////////////////////////

model ContentLibrary {
  id        String   @id @default(cuid())
  type      String // post | reels | calendar_item | remarketing
  topic     String?
  content   Json?
  cta       String?
  platform  String?
  style     String?
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

///////////////////////////////////////////////////////////////
// TRAINING SYSTEM (PHASE 15A)
///////////////////////////////////////////////////////////////

model TrainingModule {
  id        String   @id @default(cuid())
  title     String
  desc      String?
  order     Int
  category  String? // product | technical | communication | sop | culture
  role      String? // RECEPTIONIST | STYLIST | ASSISTANT | CSKH_ONLINE | ALL
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lessons TrainingLesson[]

  @@index([category])
  @@index([role])
}

model TrainingLesson {
  id        String   @id @default(cuid())
  moduleId  String
  title     String
  content   Json?
  order     Int
  role      String? // RECEPTIONIST | STYLIST | ASSISTANT | CSKH_ONLINE | ALL
  level     Int? // 1-4 (required for this role/level)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  module    TrainingModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quiz      TrainingQuiz?
  exercises TrainingExercise[]

  @@index([moduleId])
  @@index([role])
  @@index([level])
}

///////////////////////////////////////////////////////////////
// TRAINING QUIZ SYSTEM (PHASE 15C)
///////////////////////////////////////////////////////////////

model TrainingQuiz {
  id        String   @id @default(cuid())
  lessonId  String   @unique
  questions Json // Array of question objects
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson  TrainingLesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  results TrainingQuizResult[]
}

model TrainingQuizResult {
  id        String   @id @default(cuid())
  userId    String
  quizId    String
  score     Int
  total     Int
  answers   Json // Array of answer indices
  createdAt DateTime @default(now())

  quiz TrainingQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id])
}

///////////////////////////////////////////////////////////////
// TRAINING SIMULATION SYSTEM (PHASE 15D)
///////////////////////////////////////////////////////////////

model SimulationSession {
  id        String   @id @default(cuid())
  userId    String
  scenario  String
  persona   String
  messages  Json // Array of chat messages
  score     Int? // Overall score (0-100)
  feedback  Json? // Detailed evaluation feedback
  status    String   @default("active") // active | completed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

///////////////////////////////////////////////////////////////
// SKILL TRACKING SYSTEM (PHASE 15E)
///////////////////////////////////////////////////////////////

model SkillProgress {
  id        String   @id @default(cuid())
  userId    String
  skill     String // questioning | analysis | suggestion | emotion | closing
  score     Int // 0-10
  source    String // quiz | simulation | roleplay
  refId     String? // quizId hoặc simulationId (optional reference)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([skill])
}

///////////////////////////////////////////////////////////////
// SOP MASTER SYSTEM (PHASE 16A)
///////////////////////////////////////////////////////////////

model SOP {
  id        String   @id @default(cuid())
  step      Int
  title     String
  detail    Json // Nội dung quy trình chi tiết (steps, checklist, etc.)
  role      String // receptionist | stylist | assistant | online | all
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model WorkflowRun {
  id        String   @id @default(cuid())
  type      String
  input     Json
  output    Json
  createdAt DateTime @default(now())
}

model WorkflowError {
  id        String   @id @default(cuid())
  type      String
  input     Json
  error     String
  rawOutput String?
  createdAt DateTime @default(now())
}

///////////////////////////////////////////////////////////////
// OPERATIONS DASHBOARD (PHASE 16F)
///////////////////////////////////////////////////////////////

model OperationLog {
  id         String   @id @default(cuid())
  userId     String? // nhân sự thực hiện (optional vì có thể là AI/system)
  role       String // receptionist | stylist | assistant | online
  sopStep    Int // bước số mấy trong SOP (1-7)
  action     String // mô tả hành động
  customerId String?
  timestamp  DateTime @default(now())
  meta       Json? // Thông tin bổ sung (bookingId, serviceId, etc.)

  user     User?     @relation(fields: [userId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
}

///////////////////////////////////////////////////////////////
// CUSTOMER MASTER RECORD - VISIT TIMELINE (PHASE 17A)
///////////////////////////////////////////////////////////////

model Visit {
  id         String   @id @default(cuid())
  customerId String
  date       DateTime @default(now())

  // Dịch vụ & người thực hiện
  service   String // ví dụ: Uốn nóng - Nhuộm màu - Phục hồi
  stylist   String? // Tên stylist
  assistant String? // Tên assistant

  // Phần kỹ thuật (chi tiết từ AI Stylist Coach)
  technical Json? // chi tiết uốn – nhuộm – phục hồi (hairCondition, chemHistory, techniqueUsed, process, warnings, aiSummary)

  // Sản phẩm đã dùng (Phase 54)
  productsUsed Json? // [{product, gram, unitPrice, total}]

  // Tổng chi phí dịch vụ lần này
  totalCharge Int? // Tổng chi phí (để update totalSpent)

  // Ảnh
  photosBefore String[] // ảnh before
  photosAfter  String[] // ảnh after

  // Follow-up & Đánh giá
  rating        Int? // điểm đánh giá (1-5)
  followUpNotes String? // Ghi chú follow-up (24h, 48h)

  // Ghi chú tổng hợp
  notes String? // Ghi chú từ stylist/lễ tân

  // Auto Tags (tự động phân tích)
  tags String[] // ["VIP", "Risky", "Overdue", "Loyal", "Premium"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
}

///////////////////////////////////////////////////////////////
// CRM TAGS & SEGMENTATION (PHASE 17C)
///////////////////////////////////////////////////////////////

model CustomerTag {
  id         String   @id @default(cuid())
  customerId String
  tag        String // Tag name (e.g., "VIP", "Active", "Hay uốn")
  category   String? // behavior | frequency | technical | service | complaint | stylist
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, tag])
  @@index([customerId])
  @@index([tag])
}

///////////////////////////////////////////////////////////////
// REMINDER ENGINE (PHASE 17D)
///////////////////////////////////////////////////////////////

model Reminder {
  id         String    @id @default(cuid())
  customerId String
  type       String // followup | rebook_curl | recolor | appointment | recovery | overdue
  sendAt     DateTime // Thời gian gửi
  sent       Boolean   @default(false) // Đã gửi chưa
  sentAt     DateTime? // Thời gian đã gửi
  channel    String    @default("zalo") // zalo | fb | sms
  message    String // Nội dung tin nhắn
  metadata   Json? // Thông tin bổ sung (bookingId, etc.)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([sendAt])
  @@index([sent])
  @@index([type])
}

///////////////////////////////////////////////////////////////
// AI CUSTOMER INSIGHTS (PHASE 17F)
///////////////////////////////////////////////////////////////

model CustomerInsight {
  id            String   @id @default(cuid())
  customerId    String
  churnRisk     String // HIGH | MEDIUM | LOW
  revisitWindow String // Dự đoán quay lại (3-5 tuần, 6-8 tuần, etc.)
  nextService   String // Dịch vụ gợi ý tiếp theo
  promotion     String // Ưu đãi phù hợp
  summary       String // Tóm tắt khách hàng
  actionSteps   Json // Danh sách hành động [{action, priority}]
  predictions   Json? // Dự đoán chi tiết {ltv, nextPurchase, serviceInterest, etc.}
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([churnRisk])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

model FaceAnalysis {
  id         String  @id @default(cuid())
  customerId String?

  // Face shape analysis
  faceShape  String // OVAL | ROUND | SQUARE | HEART | LONG | DIAMOND
  jawline    String? // SHARP | SOFT | ROUND | SQUARE
  forehead   String? // HIGH | MEDIUM | LOW | NARROW | WIDE
  cheekbones String? // HIGH | MEDIUM | LOW | PROMINENT | SOFT
  chin       String? // SHARP | ROUND | POINTED | WEAK

  // Features
  features    String? // SHARP | SOFT | BALANCED
  overallVibe String? // FEMININE | MASCULINE | GENTLE | STRONG | DELICATE

  // Analysis data
  analysisData Json? // Detailed analysis
  imageUrl     String? // Customer photo

  // AI Generated
  isAIGenerated   Boolean @default(true)
  confidence      Float? // 0-100
  recommendations String? // AI recommendations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([faceShape])
}

model HairConditionAnalysis {
  id         String  @id @default(cuid())
  customerId String?

  // Hair condition metrics
  thickness   String? // THICK | MEDIUM | THIN
  density     String? // HIGH | MEDIUM | LOW
  elasticity  String? // HIGH | MEDIUM | LOW | POOR
  damageLevel Float? // 0-100 (%)
  porosity    String? // HIGH | MEDIUM | LOW
  dryness     String? // DRY | NORMAL | OILY
  texture     String? // SMOOTH | COARSE | ROUGH

  // Chemical history
  chemicalHistory   Json? // [{ type, date, damage }]
  lastTreatment     String? // Last chemical treatment
  lastTreatmentDate DateTime?

  // Analysis
  canPerm         Boolean? // Can perm or not
  canColor        Boolean? // Can color or not
  riskLevel       String? // LOW | MEDIUM | HIGH | CRITICAL
  recommendations String? // Safety recommendations

  // Product recommendations
  recommendedProducts String[] // Product IDs

  // AI Generated
  isAIGenerated Boolean @default(true)
  confidence    Float?
  analysisNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([damageLevel])
  @@index([riskLevel])
}

model HairstyleRecommendation {
  id              String  @id @default(cuid())
  customerId      String?
  faceAnalysisId  String?
  hairConditionId String?

  // Recommendation
  recommendedStyle String // Style name
  styleCategory    String? // LAYER | CURL | STRAIGHT | BOB | MULLET | etc.
  description      String? // Style description

  // Technical details
  curlSize   String? // 3.2 | 3.8 | 4.5 | etc.
  layerStyle String? // LONG_LAYER | SHORT_LAYER | TEXTURED
  length     String? // LONG | MEDIUM | SHORT

  // Product recommendations
  recommendedProduct String? // Plexis product (S1, S2, Acid, etc.)
  permSetting        Json? // { time, temperature, rodSize }

  // Reasons
  reasons  String[] // Why this style
  benefits String[] // Benefits of this style
  warnings String[] // Warnings/risks

  // AI confidence
  confidence Float? // 0-100
  matchScore Float? // 0-100 (how well it matches)

  // Face shape match
  faceShapeMatch Json? // How it complements face shape

  // Alternative styles
  alternatives Json? // Alternative style options

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([recommendedStyle])
}

model ColorRecommendation {
  id              String  @id @default(cuid())
  customerId      String?
  faceAnalysisId  String?
  hairConditionId String?

  // Skin tone analysis
  skinTone      String? // WARM | COOL | NEUTRAL
  skinToneLevel Float? // 1.0 - 6.0 (light to dark)
  undertone     String? // WARM | COOL | OLIVE | PINK

  // Eye color (if available)
  eyeColor String? // BROWN | BLACK | HAZEL | GREEN | BLUE

  // Personal style
  personalStyle String? // ELEGANT | CUTE | BOLD | MINIMAL | etc.

  // Recommended colors
  recommendedColor String // Color name
  colorCategory    String? // BROWN | BLONDE | BLACK | HIGHLIGHT | BALAYAGE
  colorCode        String? // Specific color code

  // Technical details
  baseColor String? // Base color needed
  technique String? // FULL_COLOR | HIGHLIGHT | BALAYAGE | OMBRE
  developer String? // Oxy level

  // Reasons
  reasons  String[] // Why this color
  benefits String[] // Benefits
  warnings String[] // Warnings

  // Alternatives
  alternatives Json? // Alternative color options

  // AI confidence
  confidence Float?
  matchScore Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([recommendedColor])
}

model HairSimulation {
  id               String  @id @default(cuid())
  customerId       String?
  recommendationId String? // Hairstyle or Color recommendation

  // Original image
  originalImageUrl String

  // Simulation settings
  style  String? // Style applied
  color  String? // Color applied
  length String? // Length adjustment

  // Generated simulation
  simulatedImageUrl String? // AI generated mock-up

  // Simulation type
  simulationType String // HAIRSTYLE | COLOR | FULL | LAYER | CURL

  // Status
  status   String @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED
  progress Float? // 0-100

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([status])
}

model StyleMatching {
  id         String  @id @default(cuid())
  customerId String?

  // Personal style analysis
  personalStyle String // ELEGANT | CUTE | BOLD | MINIMAL | CASUAL | KOREAN | JAPANESE
  styleTags     String[] // Style tags
  vibe          String? // FEMININE | MASCULINE | NEUTRAL | GENTLE | STRONG

  // Matched styles
  matchedStyles String[] // Style names that match
  matchedColors String[] // Color names that match

  // Confidence
  confidence Float?

  // AI analysis
  styleAnalysis String? // Detailed style analysis

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([personalStyle])
}

model StylistSupportPanel {
  id         String  @id @default(cuid())
  customerId String
  bookingId  String?

  // Analysis references
  faceAnalysisId  String?
  hairConditionId String?
  hairstyleRecId  String?
  colorRecId      String?

  // Support data
  supportData Json // Complete support information

  // Quick access info
  faceShape        String?
  hairCondition    String?
  recommendedStyle String?
  recommendedColor String?

  // Technical guide
  productGuide Json? // Product recommendations
  formulaGuide Json? // Formula/technique guide
  settings     Json? // Time, temperature, settings
  warnings     String[] // Important warnings

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([bookingId])
  @@index([isActive])
}

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model HairHealthScan {
  id         String  @id @default(cuid())
  customerId String?

  // Image/Video
  imageUrl String? // Customer hair photo
  videoUrl String? // Video scan

  // Health metrics
  healthScore       Float? // 0-100
  dryness           Float? // 0-100 (%)
  elasticity        String? // HIGH | MEDIUM | LOW | POOR
  damageSpots       Int? // Number of damage spots detected
  porosity          String? // HIGH | MEDIUM | LOW
  moistureRetention String? // HIGH | MEDIUM | LOW
  shine             Float? // 0-100
  colorEvenness     Float? // 0-100
  patchyColor       Boolean? // Color patchy or not

  // Hair condition details
  brokenStrands Int? // Broken hair strands
  splitEnds     Int? // Split ends count
  whiteDots     Int? // White dot damage
  burnedHair    Int? // Burned hair strands
  puffyHair     Boolean? // Puffy/swollen hair

  // Damage locations
  damageAtRoot Boolean? // Damage near root
  damageAtMid  Boolean? // Damage at mid-length
  damageAtEnd  Boolean? // Damage at ends

  // AI Analysis
  aiAnalysis      String? // Detailed AI analysis
  detectedIssues  String[] // List of detected issues
  recommendations String? // Initial recommendations

  // AI Generated
  isAIGenerated Boolean @default(true)
  confidence    Float? // 0-100

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([healthScore])
}

model DamageLevelAssessment {
  id         String  @id @default(cuid())
  customerId String?
  scanId     String? // Reference to HairHealthScan

  // Damage level
  damageLevel    Float // 0-100 (%)
  damageCategory String // LEVEL_1 | LEVEL_2 | LEVEL_3 | LEVEL_4 | LEVEL_5
  status         String? // HEALTHY | MILD | MODERATE | SEVERE | CRITICAL

  // Detailed breakdown
  cuticleDamage Float? // Cuticle layer damage (%)
  cortexDamage  Float? // Cortex damage (%)
  medullaDamage Float? // Medulla damage (%)

  // Risk factors
  breakageRisk String? // LOW | MEDIUM | HIGH | CRITICAL
  canPerm      Boolean? // Can perm or not
  canColor     Boolean? // Can color or not
  canBleach    Boolean? // Can bleach or not

  // Assessment
  assessment String? // Detailed assessment
  warnings   String[] // Important warnings

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([damageLevel])
  @@index([damageCategory])
}

model PorosityElasticityAnalysis {
  id         String  @id @default(cuid())
  customerId String?
  scanId     String?

  // Porosity
  porosity      String // HIGH | MEDIUM | LOW
  porosityLevel Float? // 0-100

  // Elasticity
  elasticity      String // HIGH | MEDIUM | LOW | POOR
  elasticityLevel Float? // 0-100
  stretchTest     Json? // Stretch test results

  // Protein/Moisture balance
  proteinLevel  Float? // Protein level
  moistureLevel Float? // Moisture level
  balance       String? // BALANCED | PROTEIN_DEFICIENT | MOISTURE_DEFICIENT

  // Analysis
  analysis        String? // Detailed analysis
  riskFactors     String[] // Risk factors identified
  recommendations String? // Recommendations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([porosity])
  @@index([elasticity])
}

model ChemicalHistoryRisk {
  id         String  @id @default(cuid())
  customerId String?

  // Chemical history
  chemicalHistory Json // [{ type, date, damage, frequency }]

  // Recent treatments
  lastPerm       DateTime?
  lastColor      DateTime?
  lastBleach     DateTime?
  lastStraighten DateTime?
  lastTreatment  DateTime?

  // Frequency
  permFrequency  String? // HIGH | MEDIUM | LOW
  colorFrequency String? // HIGH | MEDIUM | LOW
  homeDyeing     Boolean? // DIY coloring at home
  heatStyling    Boolean? // Frequent heat styling

  // Risk assessment
  riskLevel        String // LOW | MEDIUM | HIGH | CRITICAL
  riskScore        Float? // 0-100
  riskFactors      String[] // Risk factors
  cumulativeDamage Float? // Cumulative damage from all treatments

  // Recommendations
  safeToPerm      Boolean? // Safe to perm
  safeToColor     Boolean? // Safe to color
  safeToBleach    Boolean? // Safe to bleach
  recommendations String? // Safety recommendations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([riskLevel])
}

model ScalpConditionAnalysis {
  id         String  @id @default(cuid())
  customerId String?

  // Scalp condition
  scalpType    String? // OILY | DRY | NORMAL | COMBINATION
  dandruff     String? // NONE | MILD | MODERATE | SEVERE
  dandruffType String? // DRY_FLAKES | OILY_PATCHES | FUNGAL

  // Issues
  fungalInfection Boolean? // Fungal infection
  inflammation    Boolean? // Inflammation/pimples
  rootStrength    Float? // 0-100 (%)
  hairLoss        String? // NORMAL | MILD | MODERATE | SEVERE

  // Analysis
  analysis        String? // Detailed scalp analysis
  issues          String[] // Detected issues
  recommendations String? // Treatment recommendations

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([scalpType])
}

model TreatmentPlan {
  id         String  @id @default(cuid())
  customerId String?

  // References
  scanId             String?
  damageAssessmentId String?
  porosityAnalysisId String?
  chemicalRiskId     String?
  scalpAnalysisId    String?

  // Plan type
  planType String // IMMEDIATE | WEEKLY | HOMECARE | COMPREHENSIVE
  duration Int? // Duration in days

  // Immediate treatment (at salon)
  immediateTreatment Json? // Steps for immediate treatment

  // Weekly plan (7-14 days)
  weeklyPlan Json? // Weekly treatment plan

  // Homecare plan (30 days)
  homecarePlan Json? // Homecare routine

  // Treatment suitability
  permSuitability   String? // SUITABLE | CAUTION | NOT_RECOMMENDED
  colorSuitability  String? // SUITABLE | CAUTION | NOT_RECOMMENDED
  bleachSuitability String? // SUITABLE | CAUTION | NOT_RECOMMENDED

  // Products recommended
  products String[] // Product IDs recommended

  // Expected results
  expectedHealthScore Float? // Expected health score after treatment
  expectedImprovement Float? // Expected improvement (%)

  // Status
  status      String    @default("ACTIVE") // ACTIVE | COMPLETED | CANCELLED
  startedAt   DateTime?
  completedAt DateTime?

  // AI Generated
  isAIGenerated Boolean @default(true)
  confidence    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([planType])
  @@index([status])
}

model TreatmentTracking {
  id              String  @id @default(cuid())
  customerId      String
  treatmentPlanId String?

  // Tracking data
  weekNumber    Int? // Week number
  healthScore   Float // Current health score
  previousScore Float? // Previous score

  // Improvements
  improvement     Float? // Improvement percentage
  damageReduction Float? // Damage reduction (%)

  // Treatments done
  treatmentsDone Json? // Treatments completed this week

  // Products used
  productsUsed String[] // Products used

  // Notes
  notes            String? // Stylist notes
  customerFeedback String? // Customer feedback

  // AI Assessment
  aiAssessment String? // AI assessment of progress

  trackedAt DateTime @default(now())

  @@index([customerId])
  @@index([treatmentPlanId])
  @@index([trackedAt])
}

///////////////////////////////////////////////////////////////
// CRM AUTOMATION ENGINE (PHASE 17G)
///////////////////////////////////////////////////////////////

model AutomationFlow {
  id          String   @id @default(cuid())
  name        String // Tên flow (ví dụ: "Follow-up sau khi làm dịch vụ")
  description String? // Mô tả flow
  trigger     String // visit | time | tag | ai | event | manual
  conditions  Json // Điều kiện trigger {tag: "VIP", churnRisk: "HIGH", etc.}
  actions     Json // Danh sách actions [{type, payload}]
  active      Boolean  @default(true) // Bật/tắt flow
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  logs AutomationLog[]

  @@index([trigger])
  @@index([active])
}

model AutomationLog {
  id         String   @id @default(cuid())
  flowId     String
  customerId String
  action     String // Tên action đã chạy
  result     String // success | failed | skipped
  metadata   Json? // Thông tin bổ sung
  error      String? // Lỗi nếu có
  createdAt  DateTime @default(now())

  flow AutomationFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([customerId])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

///////////////////////////////////////////////////////////////
// AI TRAINING SYSTEM - PHASE 18 (ATS)
///////////////////////////////////////////////////////////////

model TrainingRole {
  id          String   @id @default(cuid())
  name        String // RECEPTIONIST | STYLIST | ASSISTANT | CSKH_ONLINE
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  levels TrainingLevel[]

  @@unique([name])
}

model TrainingLevel {
  id           String   @id @default(cuid())
  roleId       String
  level        Int // 1 = Beginner, 2 = Semi-Pro, 3 = Pro, 4 = Expert
  name         String // Beginner | Semi-Pro | Pro | Expert
  description  String?
  requirements Json? // Requirements to achieve this level
  modules      String[] // Module IDs required
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  role           TrainingRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  progress       TrainingProgress[]
  certifications Certification[]

  @@unique([roleId, level])
}

model TrainingProgress {
  id          String    @id @default(cuid())
  userId      String
  levelId     String
  moduleId    String?
  lessonId    String?
  status      String    @default("not_started") // not_started | in_progress | completed
  score       Int? // Score if completed (0-100)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  level TrainingLevel @relation(fields: [levelId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, levelId, lessonId])
  @@index([userId])
  @@index([levelId])
  @@index([moduleId])
  @@index([lessonId])
}

model TrainingExercise {
  id        String   @id @default(cuid())
  lessonId  String
  type      String // quiz | case_study | practical | video_voice
  title     String
  content   Json // Exercise content/questions
  answer    Json? // Correct answers (optional for subjective exercises)
  points    Int      @default(10)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson      TrainingLesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  submissions ExerciseSubmission[]

  @@index([lessonId])
}

model ExerciseSubmission {
  id          String   @id @default(cuid())
  exerciseId  String
  userId      String
  answer      Json // Student's answer
  score       Int? // AI-graded score (0-100)
  feedback    Json? // AI feedback
  submittedAt DateTime @default(now())

  exercise TrainingExercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([exerciseId])
  @@index([userId])
}

model RoleplaySession {
  id         String   @id @default(cuid())
  userId     String
  role       String // RECEPTIONIST | STYLIST | ASSISTANT | CSKH_ONLINE
  scenario   String // Khách khó tính | Khách muốn rẻ | etc.
  persona    String // AI customer persona
  messages   Json // Array of chat messages
  score      Int? // Overall score (0-100)
  assessment Json? // Detailed assessment {communication, technical, problemSolving, upsale, customerExperience}
  feedback   Json? // AI feedback and improvements
  status     String   @default("active") // active | completed
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([role])
}

///////////////////////////////////////////////////////////////
// SKILL ASSESSMENT SYSTEM (PHASE 18E)
///////////////////////////////////////////////////////////////

model SkillAssessment {
  id           String  @id @default(cuid())
  staffId      String // User ID
  source       String // roleplay | quiz | case_study | simulation | manual
  sourceId     String? // ID của roleplay/quiz/case_study
  scenarioType String? // khach_kho_tinh | khach_gap | etc.

  // 5 core skills (0-20 each, total 0-100)
  communication      Int // Giao tiếp
  technical          Int // Kiến thức kỹ thuật
  problemSolving     Int // Xử lý rủi ro
  customerExperience Int // Tạo trải nghiệm
  upsale             Int // Upsale tinh tế

  totalScore Int // Tổng điểm (0-100)
  level      String // Master | Excellent | Good | Average | Needs Improvement

  strengths        Json? // Array of strengths
  improvements     Json? // Array of improvements
  detailedFeedback Json? // Detailed feedback for each skill
  weaknessAnalysis Json? // AI analysis of weak points

  recommendations Json? // Personalized training recommendations

  assessedBy String? // AI | manual | system
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  staff    User    @relation("StaffAssessments", fields: [staffId], references: [id], onDelete: Cascade)
  branchId String?
  branch   Branch? @relation("StaffAssessments", fields: [branchId], references: [id])

  @@index([staffId])
  @@index([source])
  @@index([totalScore])
  @@index([level])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model Certification {
  id        String    @id @default(cuid())
  userId    String
  levelId   String
  role      String // RECEPTIONIST | STYLIST | etc.
  level     Int // 1-4
  issuedAt  DateTime  @default(now())
  expiresAt DateTime? // Optional expiration
  metadata  Json? // Additional certification data

  levelData TrainingLevel @relation(fields: [levelId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([levelId])
}

///////////////////////////////////////////////////////////////
// INVENTORY & PHA CHẾ MANAGEMENT (PHASE 19)
///////////////////////////////////////////////////////////////

model StockLog {
  id           String   @id @default(cuid())
  productId    String
  type         String // IN | OUT | ADJUST | MIX
  quantity     Float // Số lượng (+ cho IN, - cho OUT)
  pricePerUnit Float? // Giá mỗi đơn vị (cho IN)
  totalCost    Float? // Tổng chi phí (cho IN)
  note         String? // Ghi chú
  referenceId  String? // ID tham chiếu (serviceId, invoiceId, etc.)
  createdBy    String // User ID
  createdAt    DateTime @default(now())

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  creator User    @relation("StockLogCreator", fields: [createdBy], references: [id])

  @@index([productId])
  @@index([type])
  @@index([createdAt])
  @@index([createdBy])
}

model MixLog {
  id          String   @id @default(cuid())
  serviceId   String? // Booking/Service ID (optional)
  visitId     String? // Visit ID (optional)
  staffId     String // Nhân viên pha chế
  productId   String
  quantity    Float // gram / ml
  expectedQty Float? // Số lượng dự kiến (để tính hao hụt)
  actualQty   Float // Số lượng thực tế đã dùng
  cost        Float // Chi phí = quantity * pricePerUnit
  note        String? // Ghi chú
  imageUrl    String? // Ảnh minh chứng
  createdAt   DateTime @default(now())

  product  Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  staff    User    @relation("MixLogStaff", fields: [staffId], references: [id])
  branchId String?
  branch   Branch? @relation("BranchMixLog", fields: [branchId], references: [id])

  @@index([serviceId])
  @@index([visitId])
  @@index([staffId])
  @@index([productId])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model ProductCategory {
  id          String   @id @default(cuid())
  name        String // Chemical | Nhuộm | Care
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name])
}

model ServiceCost {
  id           String   @id @default(cuid())
  serviceId    String // Service ID
  visitId      String? // Visit ID (optional)
  invoiceId    String? // Invoice ID (optional)
  productId    String
  quantityUsed Float // Số lượng đã dùng (gram/ml)
  unitPrice    Float // Giá mỗi đơn vị tại thời điểm sử dụng
  totalCost    Float // quantityUsed × unitPrice
  servicePrice Float? // Giá dịch vụ (để tính margin)
  margin       Float? // Margin % ((servicePrice - totalCost) / servicePrice * 100)
  createdAt    DateTime @default(now())

  service Service? @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([productId])
  @@index([visitId])
  @@index([invoiceId])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model LossAlert {
  id        String  @id @default(cuid())
  type      String // LOSS | FRAUD | WASTAGE | INVENTORY_MISMATCH
  severity  String // WARNING | ALERT | CRITICAL
  productId String?
  staffId   String?
  serviceId String?
  mixLogId  String?

  // Loss metrics
  expectedQty Float? // Số lượng dự kiến
  actualQty   Float? // Số lượng thực tế
  lossQty     Float? // Số lượng hao hụt
  lossRate    Float? // Tỷ lệ hao hụt %

  // Fraud detection
  fraudPattern String? // Pattern detected: WRONG_GRAM | PRODUCT_SUBSTITUTION | FAKE_LOG | INVENTORY_THEFT | etc.
  fraudScore   Float? // 0-100, độ nghi ngờ gian lận
  behavior     String? // JSON: behavior analysis data

  // Threshold comparison
  thresholdType  String? // PRODUCT_TYPE | SERVICE_TYPE | STAFF_AVERAGE
  thresholdValue Float? // Giá trị ngưỡng
  deviation      Float? // Độ lệch so với ngưỡng

  // Context
  description    String? // Mô tả chi tiết
  recommendation String? // AI recommendation
  status         String  @default("OPEN") // OPEN | REVIEWED | RESOLVED | FALSE_ALARM

  // Tracking
  detectedAt DateTime  @default(now())
  reviewedAt DateTime?
  reviewedBy String? // User ID
  resolvedAt DateTime?

  product Product? @relation("LossAlertProduct", fields: [productId], references: [id], onDelete: Cascade)
  staff   User?    @relation("LossAlertStaff", fields: [staffId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([severity])
  @@index([productId])
  @@index([staffId])
  @@index([status])
  @@index([detectedAt])
}

model ThresholdRule {
  id              String  @id @default(cuid())
  productId       String? // Null = apply to category
  productCategory String? // Chemical | Nhuộm | Care
  serviceId       String? // Null = apply to all services
  serviceCategory String? // Uốn | Nhuộm | Treatment

  // Threshold values
  normalMin   Float? // Mức bình thường tối thiểu (%)
  normalMax   Float? // Mức bình thường tối đa (%)
  warningMin  Float? // Bắt đầu cảnh báo (Level 1)
  warningMax  Float? // Kết thúc cảnh báo Level 1
  alertMin    Float? // Bắt đầu cảnh báo (Level 2)
  alertMax    Float? // Kết thúc cảnh báo Level 2
  criticalMin Float? // Bắt đầu cảnh báo (Level 3)

  // Expected quantity ranges
  expectedMin Float? // Số lượng dự kiến tối thiểu (gram/ml)
  expectedMax Float? // Số lượng dự kiến tối đa (gram/ml)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, serviceId])
  @@index([productCategory])
  @@index([serviceCategory])
}

model ConsumptionTracking {
  id           String   @id @default(cuid())
  productId    String
  date         DateTime @db.Date // Ngày tiêu thụ
  quantityUsed Float // Số lượng đã dùng trong ngày (gram/ml)
  serviceCount Int      @default(0) // Số dịch vụ sử dụng sản phẩm này
  peakUsage    Float? // Lượng dùng cao nhất trong ngày
  lowUsage     Float? // Lượng dùng thấp nhất trong ngày
  topStaffId   String? // Nhân viên dùng nhiều nhất

  product  Product @relation("ConsumptionProduct", fields: [productId], references: [id], onDelete: Cascade)
  topStaff User?   @relation("ConsumptionTopStaff", fields: [topStaffId], references: [id])

  @@unique([productId, date])
  @@index([productId])
  @@index([date])
  @@index([topStaffId])
}

model InventoryProjection {
  id             String   @id @default(cuid())
  productId      String
  projectionDate DateTime @default(now()) // Ngày dự đoán

  // Current state
  currentStock Float // Tồn kho hiện tại
  safetyStock  Float? // Tồn kho an toàn

  // Consumption data
  averageDailyUsage Float // Trung bình dùng mỗi ngày (gram/ml)
  peakDailyUsage    Float? // Lượng dùng cao nhất / ngày
  lowDailyUsage     Float? // Lượng dùng thấp nhất / ngày

  // Projections
  projection7Days  Float // Dự báo dùng trong 7 ngày
  projection14Days Float // Dự báo dùng trong 14 ngày
  projection30Days Float // Dự báo dùng trong 30 ngày

  // Days until empty
  daysUntilEmpty Float? // Số ngày còn lại đến khi hết

  // AI adjustments
  seasonalFactor           Float? @default(1.0) // Hệ số mùa vụ
  trendFactor              Float? @default(1.0) // Hệ số xu hướng
  adjustedProjection30Days Float? // Dự báo 30 ngày sau khi điều chỉnh AI

  // Status
  status          String  @default("ACTIVE") // ACTIVE | ARCHIVED
  needsRestock    Boolean @default(false) // Cần nhập hàng
  restockPriority String? // HIGH | MEDIUM | LOW

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product         Product                 @relation("ProjectionProduct", fields: [productId], references: [id], onDelete: Cascade)
  recommendations RestockRecommendation[] // Phase 19J

  @@unique([productId, projectionDate])
  @@index([productId])
  @@index([projectionDate])
  @@index([needsRestock])
  @@index([restockPriority])
}

model RestockRecommendation {
  id           String  @id @default(cuid())
  productId    String
  projectionId String?

  // Current state
  currentStock   Float
  safetyStock    Float?
  daysUntilEmpty Float?

  // Recommendation
  recommendedQty  Float // Số lượng đề xuất nhập
  recommendedUnit String? // Đơn vị đề xuất (chai, tuýp, etc.)
  estimatedCost   Float? // Chi phí ước tính

  // Priority
  priority String // HIGH | MEDIUM | LOW
  reason   String? // Lý do đề xuất

  // Status
  status     String    @default("PENDING") // PENDING | APPROVED | ORDERED | RECEIVED | CANCELLED
  approvedBy String? // User ID
  approvedAt DateTime?
  orderedAt  DateTime?
  receivedAt DateTime?

  // Budget optimization
  budgetCategory String? // ESSENTIAL | IMPORTANT | OPTIONAL
  canDefer       Boolean @default(false) // Có thể hoãn

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product    Product              @relation("RestockProduct", fields: [productId], references: [id], onDelete: Cascade)
  projection InventoryProjection? @relation(fields: [projectionId], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model RestockTrigger {
  id          String @id @default(cuid())
  productId   String
  triggerType String // LOW_STOCK | PROJECTED_OUT | INCREASED_USAGE | WASTAGE_SPIKE
  severity    String // INFO | WARNING | URGENT

  currentStock Float
  threshold    Float? // Ngưỡng kích hoạt
  message      String? // Thông báo

  status         String    @default("ACTIVE") // ACTIVE | ACKNOWLEDGED | RESOLVED
  acknowledgedAt DateTime?
  resolvedAt     DateTime?

  createdAt DateTime @default(now())

  product Product @relation("RestockTriggerProduct", fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([triggerType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model DailyReport {
  id         String   @id @default(cuid())
  reportDate DateTime @db.Date // Ngày báo cáo

  // Revenue & Profit
  totalRevenue Float @default(0) // Tổng doanh thu
  totalCost    Float @default(0) // Tổng chi phí sản phẩm
  profit       Float @default(0) // Lợi nhuận
  margin       Float @default(0) // Margin %

  // Service Summary
  totalServices      Int   @default(0) // Tổng số dịch vụ
  servicesByCategory Json? // Dịch vụ theo danh mục
  topServices        Json? // Top dịch vụ

  // Product Usage
  totalProductCost Float @default(0) // Tổng chi phí sản phẩm
  productsUsed     Json? // Sản phẩm đã dùng
  unusualUsage     Json? // Sản phẩm dùng bất thường

  // Inventory Changes
  stockChanges  Json? // Thay đổi tồn kho
  lowStockItems Json? // Sản phẩm sắp hết
  stockWarnings Json? // Cảnh báo tồn kho

  // Loss Summary
  lossAlerts       Json? // Cảnh báo hao hụt
  highLossProducts Json? // Sản phẩm hao hụt cao
  totalLoss        Float @default(0) // Tổng hao hụt

  // Staff Performance
  staffRevenue  Json? // Doanh thu theo nhân viên
  staffUsage    Json? // Tiêu thụ theo nhân viên
  topPerformers Json? // Top nhân viên
  staffWarnings Json? // Cảnh báo nhân viên

  // AI Insights
  strengths       Json? // Điểm mạnh
  risks           Json? // Rủi ro
  predictions     Json? // Dự báo
  recommendations Json? // Đề xuất hành động
  aiAnalysis      String? // Phân tích AI (full text)

  // Delivery Status
  emailSent          Boolean   @default(false)
  emailSentAt        DateTime?
  zaloSent           Boolean   @default(false)
  zaloSentAt         DateTime?
  notificationSent   Boolean   @default(false)
  notificationSentAt DateTime?

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String? // User ID hoặc "SYSTEM"

  @@unique([reportDate])
  @@index([reportDate])
  @@index([generatedAt])
}

model MonthlyReport {
  id          String @id @default(cuid())
  reportMonth Int // 1-12
  reportYear  Int // 2024, 2025, etc.

  // Revenue Summary
  totalRevenue  Float  @default(0)
  totalCost     Float  @default(0)
  profit        Float  @default(0)
  margin        Float  @default(0)
  revenueGrowth Float? // % so với tháng trước
  costChange    Float? // % so với tháng trước

  // Customer Metrics
  totalCustomers     Int    @default(0)
  returningCustomers Int    @default(0)
  newCustomers       Int    @default(0)
  returnRate         Float? // Tỷ lệ khách quay lại

  // Service Performance
  servicesByCategory Json? // Doanh thu theo danh mục
  serviceRevenue     Json? // Doanh thu từng dịch vụ
  serviceCost        Json? // Chi phí từng dịch vụ
  serviceProfit      Json? // Lợi nhuận từng dịch vụ
  serviceTrends      Json? // Xu hướng dịch vụ (tăng/giảm)

  // Product Usage
  totalProductUsage      Json? // Tổng lượng sản phẩm dùng
  usageByCategory        Json? // Sử dụng theo nhóm
  averageUsagePerService Json? // Trung bình mỗi dịch vụ
  productCostByCategory  Json? // Chi phí theo nhóm

  // Inventory Movement
  stockIn       Float @default(0) // Nhập
  stockOut      Float @default(0) // Xuất
  endingStock   Float @default(0) // Tồn cuối kỳ
  excessStock   Json? // Sản phẩm dư kho
  lowStockItems Json? // Sản phẩm sắp hết

  // Loss & Fraud
  averageLossRate   Float? // Hao hụt trung bình
  lossChange        Float? // % thay đổi so với tháng trước
  highLossProducts  Json? // Sản phẩm hao hụt cao
  suspiciousStaff   Json? // Nhân viên nghi vấn
  inventoryMismatch Float? // % lệch tồn kho vs log

  // Staff Performance
  staffRevenue    Json? // Doanh thu theo nhân viên
  staffEfficiency Json? // Tiết kiệm sản phẩm
  staffWarnings   Json? // Cảnh báo nhân viên
  topPerformers   Json? // Top nhân viên

  // AI Recommendations
  costOptimization      Json? // Tối ưu chi phí
  inventoryOptimization Json? // Tối ưu tồn kho
  marketingSuggestions  Json? // Gợi ý marketing
  trainingNeeds         Json? // Nhu cầu đào tạo
  aiSummary             String? // Tóm tắt AI

  // Metadata
  generatedAt DateTime @default(now())
  generatedBy String? // User ID hoặc "SYSTEM"

  @@unique([reportMonth, reportYear])
  @@index([reportYear, reportMonth])
  @@index([generatedAt])
}

// ============================================
// PHASE 20 - CUSTOMER JOURNEY INTELLIGENCE
// ============================================

model CustomerJourney {
  id             String   @id @default(cuid())
  customerId     String
  journeyStage   String // AWARENESS | CONSIDERATION | BOOKING | SERVICE | CHECKOUT | POST_SERVICE | RETURN
  stageData      Json? // Data specific to stage
  touchpoint     String? // INBOX | CALL | VISIT | CHAT | REVIEW | etc.
  touchpointData Json? // Touchpoint-specific data
  timestamp      DateTime @default(now())

  // Metadata
  source   String? // How they found salon (FB, Google, Friend, etc.)
  campaign String? // Marketing campaign if applicable
  device   String? // Mobile | Desktop | Tablet

  customer Customer @relation("CustomerJourneyCustomer", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([journeyStage])
  @@index([touchpoint])
  @@index([timestamp])
}

model CustomerTouchpoint {
  id         String  @id @default(cuid())
  customerId String
  type       String // INBOX | CALL | BOOKING | SERVICE | CHECKOUT | FOLLOW_UP | REVIEW | REFERRAL
  channel    String? // Zalo | Phone | In-person | Email | FB

  // Touchpoint data
  responseTime Int? // seconds (for inbox/call)
  content      String? // Message content or summary
  outcome      String? // SUCCESS | FAILED | PENDING | NO_RESPONSE
  metadata     Json? // Additional data

  // Staff involved
  staffId String? // CSKH, Stylist, etc.

  createdAt DateTime @default(now())

  customer Customer @relation("CustomerTouchpointCustomer", fields: [customerId], references: [id], onDelete: Cascade)
  staff    User?    @relation("TouchpointStaff", fields: [staffId], references: [id])

  @@index([customerId])
  @@index([type])
  @@index([channel])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model CustomerExperience {
  id         String  @id @default(cuid())
  customerId String
  serviceId  String? // Service/Visit ID
  visitId    String? // Visit ID

  // Experience scores (0-100)
  consultationScore Float? // Chất lượng tư vấn
  technicalScore    Float? // Chất lượng kỹ thuật
  attitudeScore     Float? // Thái độ stylist
  waitTimeScore     Float? // Thời gian chờ
  valueScore        Float? // Giá cả vs giá trị
  careScore         Float? // Care sau dịch vụ

  overallScore Float // Tổng điểm (0-100)

  // Feedback
  strengths    String? // Điểm mạnh
  improvements String? // Điểm cần cải thiện
  feedback     String? // Feedback chi tiết

  // AI Analysis
  aiAnalysis String? // AI phân tích trải nghiệm
  sentiment  String? // POSITIVE | NEUTRAL | NEGATIVE

  createdAt DateTime @default(now())

  customer Customer @relation("CustomerExperienceCustomer", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([overallScore])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model CustomerBehavior {
  id           String @id @default(cuid())
  customerId   String
  behaviorType String // VIP | HIGH_VALUE | TREND | PRICE_SENSITIVE | RISK_AVERSE | CHURN_RISK
  behaviorData Json? // Behavior-specific data
  confidence   Float? // AI confidence (0-100)

  // Attributes
  totalSpent         Float     @default(0)
  visitCount         Int       @default(0)
  averageSpend       Float     @default(0)
  favoriteService    String? // Dịch vụ yêu thích
  visitFrequency     Float? // Lần/tháng
  lastVisit          DateTime?
  nextPredictedVisit DateTime? // AI dự đoán

  // Preferences
  preferredStylist String? // Stylist ID
  preferredTime    String? // Sáng | Trưa | Chiều | Tối
  preferredDay     String? // Ngày yêu thích

  // Lifetime Value
  lifetimeValue  Float  @default(0) // CLV
  predictedValue Float? // Giá trị dự đoán

  // Analysis
  aiAnalysis String? // AI phân tích hành vi
  tags       String[] // Tags: VIP, Trendy, Price-sensitive, etc.

  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  customer Customer @relation("CustomerBehaviorCustomer", fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId])
  @@index([behaviorType])
  @@index([totalSpent])
  @@index([lifetimeValue])
}

model CustomerRiskAlert {
  id         String @id @default(cuid())
  customerId String
  riskType   String // CHURN | LOW_ENGAGEMENT | NEGATIVE_FEEDBACK | NO_RESPONSE
  riskScore  Float // 0-100, độ rủi ro
  severity   String // LOW | MEDIUM | HIGH | CRITICAL

  // Risk factors
  factors            Json? // Các yếu tố rủi ro
  lastContact        DateTime? // Lần liên hệ cuối
  daysSinceLastVisit Int? // Số ngày từ lần đến cuối
  lastScore          Float? // Experience score lần cuối

  // Prediction
  churnProbability   Float? // Xác suất bỏ salon (%)
  predictedChurnDate DateTime? // Ngày dự đoán bỏ salon

  // Actions
  recommendedAction String? // Hành động đề xuất
  actionTaken       String? // Hành động đã thực hiện
  status            String  @default("ACTIVE") // ACTIVE | ACKNOWLEDGED | RESOLVED | FALSE_ALARM

  detectedAt DateTime  @default(now())
  resolvedAt DateTime?

  customer Customer @relation("CustomerRiskAlertCustomer", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([riskType])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
}

model CustomerPrediction {
  id             String @id @default(cuid())
  customerId     String
  predictionType String // RETURN | NEXT_SERVICE | SPEND | CHURN

  // Return prediction
  returnProbability   Float? // Xác suất quay lại (%)
  predictedReturnDate DateTime? // Ngày dự đoán quay lại
  predictedService    String? // Dịch vụ dự đoán
  predictedSpend      Float? // Chi tiêu dự đoán

  // Model data
  modelVersion String? // AI model version
  confidence   Float? // Confidence (0-100)
  factors      Json? // Factors used in prediction

  createdAt DateTime  @default(now())
  expiresAt DateTime? // Prediction expiry date

  customer Customer @relation("CustomerPredictionCustomer", fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([customerId, predictionType])
  @@index([customerId])
  @@index([predictionType])
  @@index([returnProbability])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

// ============================================
// PHASE 21 - MARKETING INTELLIGENCE & GROWTH AUTOMATION
// ============================================

model MarketingChannel {
  id        String   @id @default(cuid())
  name      String // Facebook | Instagram | TikTok | Google | Referral | Walk-in
  type      String // PAID | ORGANIC | REFERRAL | DIRECT
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns  MarketingCampaign[]
  dataPoints MarketingDataPoint[]

  @@unique([name])
  @@index([type])
}

model MarketingDataPoint {
  id        String   @id @default(cuid())
  channelId String
  date      DateTime @db.Date

  // Metrics
  leads       Int @default(0) // Lượt inbox/call
  bookings    Int @default(0) // Đặt lịch
  arrivals    Int @default(0) // Đến salon
  conversions Int @default(0) // Chốt dịch vụ

  // Costs
  adSpend   Float @default(0) // Chi phí quảng cáo
  totalCost Float @default(0) // Tổng chi phí

  // Revenue
  revenue Float @default(0) // Doanh thu từ kênh này

  // Calculated
  costPerLead     Float? // CAC per lead
  costPerCustomer Float? // CAC per customer
  conversionRate  Float? // Tỷ lệ chuyển đổi
  returnRate      Float? // Tỷ lệ quay lại

  metadata Json? // Additional data

  channel MarketingChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, date])
  @@index([channelId])
  @@index([date])
}

model MarketingContent {
  id          String   @id @default(cuid())
  campaignId  String?
  contentType String // POST | AD | REEL | SCRIPT | IMAGE_PROMPT
  title       String?
  content     String // Full content text
  imagePrompt String? // AI image generation prompt
  hashtags    String[] // Hashtags array
  platform    String? // Facebook | Instagram | TikTok

  // Scheduling
  scheduledDate DateTime?
  publishedDate DateTime?
  isPublished   Boolean   @default(false)

  // Performance
  views    Int @default(0)
  likes    Int @default(0)
  comments Int @default(0)
  shares   Int @default(0)
  clicks   Int @default(0)

  // AI Generated
  isAIGenerated    Boolean @default(false)
  aiModel          String? // Model used
  generationPrompt String? // Original prompt

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([contentType])
  @@index([platform])
  @@index([scheduledDate])
}

model MarketingAutomation {
  id          String  @id @default(cuid())
  campaignId  String?
  name        String
  triggerType String // NEW_CUSTOMER | RISK_CUSTOMER | VIP | POST_SERVICE | BIRTHDAY
  segment     String? // Customer segment

  // Flow steps
  steps Json // Array of automation steps

  // Schedule
  isActive  Boolean   @default(true)
  startDate DateTime?
  endDate   DateTime?

  // Performance
  triggered  Int @default(0) // Số lần trigger
  completed  Int @default(0) // Số lần hoàn thành
  conversion Int @default(0) // Số lần chuyển đổi

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaign MarketingCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  @@index([campaignId])
  @@index([triggerType])
  @@index([isActive])
}

model MarketingSegment {
  id          String  @id @default(cuid())
  name        String // VIP | HIGH_SPENDER | TREND_HUNTER | BEAUTY_ADDICT | BUDGET | ONE_TIME | RISK | REFERRAL
  description String?

  // Criteria (JSON)
  criteria Json? // Segmentation criteria

  // Stats
  customerCount Int   @default(0)
  averageLTV    Float @default(0)
  averageSpend  Float @default(0)

  // AI Generated
  isAIGenerated Boolean @default(false)
  aiAnalysis    String? // AI analysis of segment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name])
  @@index([name])
}

model MarketingTrend {
  id          String  @id @default(cuid())
  trendType   String // HAIR_STYLE | COLOR | TECHNIQUE | SEASONAL
  title       String
  description String?

  // Trend data
  popularity Float? // 0-100
  season     String? // Spring | Summer | Fall | Winter
  source     String? // KOREA | JAPAN | LOCAL | GLOBAL

  // AI Analysis
  aiAnalysis      String?
  recommendations Json? // AI recommendations

  detectedAt DateTime  @default(now())
  expiresAt  DateTime?

  @@index([trendType])
  @@index([detectedAt])
}

model CompetitorAnalysis {
  id             String  @id @default(cuid())
  competitorName String
  location       String? // Khu vực

  // Pricing
  servicePrices Json? // Service prices

  // Services
  services Json? // Services offered

  // Marketing
  activeCampaigns Json? // Active campaigns detected
  promotions      Json? // Current promotions

  // Analysis
  strengths     Json? // Competitor strengths
  weaknesses    Json? // Competitor weaknesses
  opportunities Json? // Opportunities for us

  analyzedAt DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([competitorName])
  @@index([analyzedAt])
}

// ============================================
// PHASE 22 - SALES FUNNEL AUTOMATION & UPSALE ENGINE
// ============================================

model UpsaleMatrix {
  id          String  @id @default(cuid())
  serviceId   String? // Service that triggers upsale
  serviceName String // Service name (if no serviceId)

  // Upsale items
  recommendedServices String[] // Service IDs to recommend
  recommendedProducts String[] // Product IDs to recommend

  // Upsale data
  upsaleType     String // SERVICE | PRODUCT | COMBO
  priority       Int    @default(0) // Higher = more priority
  conversionRate Float? // Expected conversion rate (%)

  // Conditions
  conditions Json? // Conditions for upsale (customer type, price range, etc.)

  // Script
  script   String? // Suggested script for stylist
  benefits String[] // Key benefits to mention

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId])
  @@index([serviceName])
  @@index([upsaleType])
}

model UpsaleRecommendation {
  id         String  @id @default(cuid())
  customerId String
  serviceId  String? // Current service
  invoiceId  String? // Current invoice

  // Recommendations
  recommendedServices String[] // Service IDs
  recommendedProducts String[] // Product IDs
  combo               Json? // Combo suggestions

  // AI Generated
  isAIGenerated Boolean @default(true)
  confidence    Float? // 0-100
  reason        String? // Why recommend these items
  script        String? // Suggested script
  tone          String? // Communication tone

  // Status
  status        String   @default("PENDING") // PENDING | ACCEPTED | REJECTED | SOLD
  acceptedItems String[] // Items customer accepted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer Customer @relation("CustomerUpsaleRecommendation", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([serviceId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

model SalesFunnel {
  id          String  @id @default(cuid())
  customerId  String?
  funnelStage String // AWARENESS | CONSIDERATION | DECISION | CHECKOUT | POST_SERVICE | RETURN

  // Funnel data
  entryPoint     String? // How customer entered funnel
  currentService String? // Service customer is interested in
  currentProduct String? // Product customer is interested in

  // Progress
  stepsCompleted String[] // Steps customer completed
  currentStep    String? // Current step in funnel

  // Automation
  automationActive Boolean   @default(true)
  nextAction       String? // Next automated action
  nextActionDate   DateTime? // When to trigger next action

  // Metrics
  timeInFunnel          Int? // Minutes in funnel
  conversionProbability Float? // 0-100

  metadata Json? // Additional data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([funnelStage])
  @@index([nextActionDate])
}

model AbandonedCart {
  id         String  @id @default(cuid())
  customerId String?
  phone      String? // If no customerId

  // Abandonment data
  abandonmentType String // INBOX_NO_BOOKING | BOOKING_NO_ARRIVAL | NO_CHECKOUT | VIEWED_NO_ACTION
  originalIntent  String? // Service/product customer was interested in

  // Recovery attempts
  recoveryAttempts Int       @default(0)
  lastAttempt      DateTime?
  nextAttempt      DateTime?

  // Status
  status String @default("ABANDONED") // ABANDONED | RECOVERED | CONVERTED | LOST

  // Data
  metadata Json? // Original data (inbox message, booking, etc.)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([phone])
  @@index([abandonmentType])
  @@index([status])
  @@index([nextAttempt])
}

model UpsaleRecord {
  id         String  @id @default(cuid())
  invoiceId  String
  customerId String
  staffId    String? // Staff who did upsale

  // Upsale details
  originalAmount Float // Original invoice amount
  upsaleAmount   Float // Additional amount from upsale
  totalAmount    Float // Final amount

  // Items
  originalItems String[] // Original service/product IDs
  upsaleItems   String[] // Upsale service/product IDs

  // Source
  source           String // MATRIX | AI | MANUAL | AUTOMATION
  recommendationId String? // If from AI recommendation

  // Metrics
  upsaleRate     Float? // Upsale rate (%)
  conversionType String? // SERVICE_UPGRADE | PRODUCT_ADD | COMBO

  createdAt DateTime @default(now())

  customer Customer @relation("CustomerUpsaleRecord", fields: [customerId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([customerId])
  @@index([staffId])
  @@index([source])
  @@index([createdAt])
}

// ============================================
// PHASE 23 - AI STYLIST ASSISTANT 2.0
// ============================================

// ============================================
// PHASE 24 - AI HAIR HEALTH DIAGNOSIS & TREATMENT ENGINE
// ============================================

// ============================================
// PHASE 25 - AI QUALITY CONTROL & SERVICE STANDARDIZATION
// ============================================

model ServiceSOP {
  id          String  @id @default(cuid())
  serviceId   String?
  serviceName String // Service name if no serviceId

  // SOP Steps
  steps Json // Array of SOP steps with details

  // Standard parameters
  standardParams Json? // Standard parameters (time, temperature, etc.)

  // Requirements
  prerequisites String[] // Required checks before starting
  materials     String[] // Required materials/products

  // Quality standards
  qualityStandards Json? // Quality standards for this service

  // Version control
  version  String  @default("1.0")
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId])
  @@index([serviceName])
  @@index([isActive])
}

model TechnicalChecklist {
  id          String  @id @default(cuid())
  serviceId   String?
  serviceName String?
  bookingId   String?

  // Checklist items
  items Json // Array of checklist items

  // Status
  completedItems String[] // Completed item IDs
  pendingItems   String[] // Pending item IDs
  skippedItems   String[] // Skipped item IDs

  // Completion
  completionRate Float? // 0-100 (%)
  isCompleted    Boolean @default(false)

  // AI Verification
  aiVerified Boolean  @default(false)
  aiWarnings String[] // AI warnings for missing items

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId])
  @@index([bookingId])
  @@index([isCompleted])
}

model QualityScore {
  id        String  @id @default(cuid())
  bookingId String?
  serviceId String?
  staffId   String?

  // Score breakdown
  overallScore     Float // 0-100
  technicalScore   Float? // Technical execution score
  consistencyScore Float? // Consistency score
  timingScore      Float? // Timing accuracy score
  productScore     Float? // Product usage score

  // Detailed metrics
  evenness      Float? // Setting evenness (0-100)
  tension       Float? // Hair tension (0-100)
  productAmount Float? // Product amount (0-100)
  spacing       Float? // Product spacing (0-100)
  temperature   Float? // Temperature accuracy (0-100)
  timing        Float? // Timing accuracy (0-100)

  // AI Analysis
  aiAnalysis String? // AI analysis of quality
  strengths  String[] // Strengths identified
  weaknesses String[] // Weaknesses identified

  // Real-time data
  capturedAt DateTime @default(now()) // When score was captured

  @@index([bookingId])
  @@index([serviceId])
  @@index([staffId])
  @@index([overallScore])
  @@index([capturedAt])
}

model ErrorDetection {
  id        String  @id @default(cuid())
  bookingId String?
  serviceId String?
  staffId   String?

  // Error details
  errorType     String // OVERPROCESS | UNDERPROCESS | UNEVEN | OVERHEAT | etc.
  errorCategory String // TECHNICAL | TIMING | PRODUCT | PROCEDURE
  severity      String // LOW | MEDIUM | HIGH | CRITICAL

  // Error location
  location String? // Where error occurred (e.g., "top section", "back")

  // Error description
  description String // Detailed error description
  detectedAt  DateTime @default(now())

  // Detection method
  detectionMethod String // AI | MANUAL | SYSTEM

  // Status
  status String @default("DETECTED") // DETECTED | ACKNOWLEDGED | CORRECTED | IGNORED

  // Correction
  corrected       Boolean   @default(false)
  correctedAt     DateTime?
  correctionNotes String?

  @@index([bookingId])
  @@index([serviceId])
  @@index([staffId])
  @@index([errorType])
  @@index([severity])
  @@index([status])
}

model ConsistencyMetrics {
  id        String  @id @default(cuid())
  staffId   String?
  serviceId String?

  // Time period
  periodStart DateTime
  periodEnd   DateTime

  // Metrics
  avgSetting       Float? // Average setting value
  avgProductAmount Float? // Average product amount
  avgTiming        Float? // Average timing
  avgQualityScore  Float? // Average quality score

  // Comparison
  teamAvgSetting Float? // Team average
  teamAvgQuality Float? // Team average quality

  // Consistency score
  consistencyScore Float? // 0-100 (how consistent vs team)
  deviation        Float? // Deviation from team average

  // Analysis
  analysis        String? // Consistency analysis
  recommendations String[] // Recommendations for improvement

  createdAt DateTime @default(now())

  @@index([staffId])
  @@index([serviceId])
  @@index([periodStart])
}

model CorrectionSuggestion {
  id        String  @id @default(cuid())
  errorId   String? // Reference to ErrorDetection
  bookingId String?

  // Suggestion
  suggestion String // Correction suggestion
  action     String? // Specific action to take

  // Priority
  priority String @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT

  // Status
  status    String    @default("PENDING") // PENDING | APPLIED | REJECTED
  appliedAt DateTime?

  // AI Generated
  isAIGenerated Boolean @default(true)
  confidence    Float? // 0-100

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([errorId])
  @@index([bookingId])
  @@index([status])
}

model PostServiceAudit {
  id        String  @id @default(cuid())
  bookingId String?
  serviceId String?
  staffId   String?

  // Audit scores
  auditScore    Float // 0-100 (overall audit score)
  colorScore    Float? // Color evenness (0-100)
  curlScore     Float? // Curl/wave quality (0-100)
  shineScore    Float? // Shine/gloss (0-100)
  evennessScore Float? // Overall evenness (0-100)

  // Analysis
  aiAnalysis   String? // AI analysis of result
  strengths    String[] // Strengths
  improvements String[] // Areas for improvement

  // Images
  beforeImageUrl String? // Before photo
  afterImageUrl  String? // After photo

  // Status
  status String @default("PENDING") // PENDING | COMPLETED | REVIEWED

  // Review
  reviewedBy  String? // Reviewer ID
  reviewedAt  DateTime?
  reviewNotes String?

  auditedAt DateTime @default(now())

  @@index([bookingId])
  @@index([serviceId])
  @@index([staffId])
  @@index([auditScore])
  @@index([auditedAt])
}

// ============================================
// PHASE 26 - BRANCH MANAGEMENT & MULTI-SALON CONTROL SYSTEM
// ============================================

model Branch {
  id        String  @id @default(cuid())
  partnerId String? // Phase 27: Partner isolation
  name      String // Branch name (e.g., "Chí Tâm - Quận 1")
  code      String? // Branch code (e.g., "CT-Q1")
  address   String?
  phone     String?
  email     String?

  // Management
  managerId String? // Branch manager user ID
  isActive  Boolean @default(true)

  // Settings
  timezone String? @default("Asia/Ho_Chi_Minh")
  currency String? @default("VND")

  // Metadata
  metadata Json? // Additional branch data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  partner  Partner?  @relation("PartnerBranches", fields: [partnerId], references: [id], onDelete: Cascade)
  mixLogs  MixLog[]  @relation("BranchMixLog")
  bookings Booking[] @relation("BranchBooking")
  invoices Invoice[] @relation("BranchInvoice")

  users              User[]                  @relation("BranchUsers")
  productStock       ProductStock[]
  stockTransactions  StockTransaction[]
  stockTransfersFrom StockTransfer[]         @relation("TransferFrom")
  stockTransfersTo   StockTransfer[]         @relation("TransferTo")
  stockReceipts      StockReceipt[]          @relation("ReceiptBranch")
  stockIssues        StockIssue[]            @relation("IssueBranch")
  locations          Location[]
  salaryPayout       SalaryPayout[]
  staffAssessments   SkillAssessment[]       @relation("StaffAssessments")
  staffAssignments   BranchStaffAssignment[] @relation("BranchStaffAssignment")
  inventories        BranchInventory[]       @relation("BranchInventoryBranch")

  performances BranchPerformance[] @relation("BranchPerformanceBranch")
  forecasts    BranchForecast[]    @relation("BranchForecastBranch")

  @@unique([code])
  @@index([name])
  @@index([partnerId])
  @@index([isActive])
}

model BranchStaffAssignment {
  id       String @id @default(cuid())
  staffId  String
  branchId String

  // Assignment type
  assignmentType String  @default("FULL_TIME") // FULL_TIME | PART_TIME | ROTATING
  isPrimary      Boolean @default(false) // Primary branch

  // Schedule (for rotating staff)
  schedule Json? // Schedule configuration

  // Status
  isActive  Boolean   @default(true)
  startDate DateTime  @default(now())
  endDate   DateTime?

  staff  User   @relation("StaffBranchAssignment", fields: [staffId], references: [id], onDelete: Cascade)
  branch Branch @relation("BranchStaffAssignment", fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([staffId, branchId])
  @@index([staffId])
  @@index([branchId])
  @@index([isActive])
}

model BranchInventory {
  id        String @id @default(cuid())
  branchId  String
  productId String

  // Stock
  stock         Float @default(0)
  reservedStock Float @default(0) // Reserved for bookings

  // Safety stock
  safetyStock  Float? // Minimum stock level
  reorderPoint Float? // Reorder point

  // Last updated
  lastUpdated DateTime @default(now())

  branch  Branch  @relation("BranchInventoryBranch", fields: [branchId], references: [id], onDelete: Cascade)
  product Product @relation("BranchInventoryProduct", fields: [productId], references: [id], onDelete: Cascade)

  @@unique([branchId, productId])
  @@index([branchId])
  @@index([productId])
}

model BranchPerformance {
  id       String @id @default(cuid())
  branchId String

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // DAILY | WEEKLY | MONTHLY

  // Revenue
  revenue Float  @default(0)
  profit  Float  @default(0)
  margin  Float? // Profit margin (%)

  // Customer metrics
  totalCustomers     Int    @default(0)
  newCustomers       Int    @default(0)
  returningCustomers Int    @default(0)
  returnRate         Float? // Return rate (%)

  // Service metrics
  totalServices  Int    @default(0)
  avgServiceTime Float? // Average service time (minutes)
  conversionRate Float? // Conversion rate (%)

  // Cost metrics
  productCost Float @default(0)
  staffCost   Float @default(0)
  otherCosts  Float @default(0)

  // Quality metrics
  avgQualityScore Float? // Average quality score
  errorRate       Float? // Error rate (%)
  customerRating  Float? // Average customer rating

  // Loss metrics
  lossRate    Float? // Loss rate (%)
  wasteAmount Float? // Waste amount

  branch Branch @relation("BranchPerformanceBranch", fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([branchId, periodStart, periodType])
  @@index([branchId])
  @@index([periodStart])
  @@index([periodType])
}

model BranchForecast {
  id       String @id @default(cuid())
  branchId String

  // Forecast period
  forecastDate DateTime
  forecastType String // REVENUE | CUSTOMERS | STAFF_NEED | GROWTH

  // Forecast data
  predictedValue Float? // Predicted value
  confidence     Float? // Confidence level (0-100)
  factors        Json? // Factors used in forecast

  // AI Analysis
  aiAnalysis      String? // AI analysis
  recommendations String[] // Recommendations

  // Status
  status String @default("ACTIVE") // ACTIVE | ARCHIVED

  createdAt DateTime @default(now())

  branch Branch @relation("BranchForecastBranch", fields: [branchId], references: [id], onDelete: Cascade)

  @@index([branchId])
  @@index([forecastDate])
  @@index([forecastType])
}

model CrossBranchQuality {
  id String @id @default(cuid())

  // Comparison period
  periodStart DateTime
  periodEnd   DateTime

  // Quality metrics by branch
  branchMetrics Json // { branchId: { qualityScore, errorRate, etc. } }

  // Comparison
  avgQuality  Float? // Average quality across branches
  bestBranch  String? // Best performing branch ID
  worstBranch String? // Worst performing branch ID

  // Analysis
  analysis        String? // Cross-branch analysis
  recommendations String[] // Recommendations for improvement

  createdAt DateTime @default(now())

  @@index([periodStart])
}

// ============================================
// PHASE 27 - FRANCHISE & PARTNER MODULE
// ============================================

model Partner {
  id        String  @id @default(cuid())
  salonName String
  ownerName String?
  phone     String?
  email     String?

  // License & Plan
  plan             String    @default("BASIC") // BASIC | PRO | ENTERPRISE
  licenseStatus    String    @default("ACTIVE") // ACTIVE | EXPIRED | SUSPENDED | TRIAL
  licenseStartDate DateTime  @default(now())
  licenseEndDate   DateTime?

  // Settings
  timezone String? @default("Asia/Ho_Chi_Minh")
  currency String? @default("VND")
  language String? @default("vi")

  // Metadata
  metadata Json? // Additional partner data
  notes    String? // HQ notes

  // HQ Control
  isActive        Boolean   @default(true)
  suspendedAt     DateTime?
  suspendedReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  branches      Branch[]              @relation("PartnerBranches")
  users         User[]                @relation("PartnerUsers")
  licenses      License[]             @relation("PartnerLicense")
  performances  PartnerPerformance[]  @relation("PartnerPerformance")
  qualityScores PartnerQualityScore[] @relation("PartnerQuality")

  @@index([salonName])
  @@index([plan])
  @@index([licenseStatus])
  @@index([isActive])
}

model License {
  id        String @id @default(cuid())
  partnerId String

  // License details
  plan   String // BASIC | PRO | ENTERPRISE
  price  Float // Monthly price
  period Int // Period in months

  // Dates
  startDate DateTime
  endDate   DateTime
  autoRenew Boolean  @default(true)

  // Payment
  status          String    @default("ACTIVE") // ACTIVE | EXPIRED | SUSPENDED | CANCELLED
  paymentStatus   String    @default("PENDING") // PENDING | PAID | OVERDUE | CANCELLED
  lastPaymentDate DateTime?
  nextPaymentDate DateTime?

  // Payment history
  paymentHistory Json? // Array of payment records

  // Notifications
  reminderSent   Boolean   @default(false)
  reminderSentAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  partner Partner @relation("PartnerLicense", fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([status])
  @@index([plan])
  @@index([endDate])
}

model PartnerPerformance {
  id        String @id @default(cuid())
  partnerId String

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // WEEKLY | MONTHLY | QUARTERLY

  // Revenue
  revenue Float  @default(0)
  profit  Float  @default(0)
  margin  Float? // Profit margin (%)

  // Customer metrics
  totalCustomers     Int    @default(0)
  newCustomers       Int    @default(0)
  returningCustomers Int    @default(0)
  returnRate         Float? // Return rate (%)

  // Service metrics
  totalServices  Int    @default(0)
  avgServiceTime Float? // Average service time (minutes)
  conversionRate Float? // Conversion rate (%)
  upsaleRate     Float? // Upsale rate (%)

  // Cost metrics
  productCost Float @default(0)
  staffCost   Float @default(0)
  otherCosts  Float @default(0)

  // Quality metrics
  avgQualityScore Float? // Average quality score
  errorRate       Float? // Error rate (%)
  customerRating  Float? // Average customer rating

  // Loss metrics
  lossRate    Float? // Loss rate (%)
  wasteAmount Float? // Waste amount

  // AI Analysis
  aiAnalysis      String? // AI analysis
  strengths       String[] // Strengths
  weaknesses      String[] // Weaknesses
  recommendations String[] // Recommendations

  createdAt DateTime @default(now())

  partner Partner @relation("PartnerPerformance", fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, periodStart, periodType])
  @@index([partnerId])
  @@index([periodStart])
  @@index([periodType])
}

model PartnerQualityScore {
  id        String @id @default(cuid())
  partnerId String

  // Time period
  periodStart DateTime
  periodEnd   DateTime

  // Quality scores
  overallScore     Float // 0-100
  technicalScore   Float? // Technical quality
  serviceScore     Float? // Service quality
  consistencyScore Float? // Consistency score

  // SOP Compliance
  sopCompliance Float? // SOP compliance rate (%)
  sopViolations Json? // SOP violations details

  // Error analysis
  errorCount     Int   @default(0)
  errorTypes     Json? // Error types breakdown
  criticalErrors Int   @default(0)

  // AI Analysis
  aiAnalysis      String? // AI quality analysis
  recommendations String[] // Quality improvement recommendations

  createdAt DateTime @default(now())

  partner Partner @relation("PartnerQuality", fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([partnerId])
  @@index([periodStart])
  @@index([overallScore])
}

model SOPEnforcement {
  id        String  @id @default(cuid())
  partnerId String? // Null = apply to all partners
  branchId  String? // Null = apply to all branches

  // SOP details
  sopId            String? // Reference to ServiceSOP
  sopVersion       String?
  enforcementLevel String  @default("REQUIRED") // REQUIRED | RECOMMENDED | OPTIONAL

  // Status
  status String @default("ACTIVE") // ACTIVE | INACTIVE | PENDING

  // Dates
  effectiveDate DateTime  @default(now())
  expiryDate    DateTime?

  // Monitoring
  monitored       Boolean @default(true)
  violationsCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([partnerId])
  @@index([branchId])
  @@index([status])
}

model HQNotification {
  id        String  @id @default(cuid())
  partnerId String? // Null = broadcast to all

  // Notification details
  type      String // SYSTEM_UPDATE | SOP_UPDATE | ALERT | TRAINING | PAYMENT
  priority  String  @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT
  title     String
  message   String
  actionUrl String? // URL to action if needed

  // Status
  status String    @default("PENDING") // PENDING | SENT | READ | ACKNOWLEDGED
  sentAt DateTime?
  readAt DateTime?

  // Recipients
  recipients Json? // Array of user IDs or roles

  createdAt DateTime @default(now())

  @@index([partnerId])
  @@index([type])
  @@index([status])
  @@index([priority])
}

// ============================================
// PHASE 28 - AI VOICE ASSISTANT (MINA 3.0)
// ============================================

model VoiceSession {
  id String @id @default(cuid())

  // Session type
  sessionType String // PHONE_CALL | VOICE_MESSAGE | INTERCOM | CHAT_VOICE
  channel     String? // PHONE | ZALO | FACEBOOK | WEBSITE | IN_PERSON

  // Participants
  customerId    String? // Customer if available
  customerPhone String? // Phone number
  customerName  String? // Customer name
  staffId       String? // Staff member if intercom mode
  branchId      String? // Branch context
  partnerId     String? // Partner context

  // Session metadata
  startedAt DateTime  @default(now())
  endedAt   DateTime?
  duration  Int? // Duration in seconds
  status    String    @default("ACTIVE") // ACTIVE | COMPLETED | CANCELLED | TRANSFERRED

  // Session summary
  summary     String? // AI-generated summary
  intent      String? // Detected intent
  resolved    Boolean @default(false) // Whether issue was resolved
  actionTaken String? // Action taken (BOOKING_CREATED | INFO_PROVIDED | etc.)

  // Phone call specific
  callId          String? // External call ID
  callDirection   String? // INBOUND | OUTBOUND
  transferToHuman Boolean @default(false)
  transferReason  String?

  // Recording
  recordingUrl String? // Full conversation recording

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  interactions VoiceInteraction[] @relation("SessionInteractions")

  @@index([customerId])
  @@index([staffId])
  @@index([branchId])
  @@index([partnerId])
  @@index([sessionType])
  @@index([status])
  @@index([startedAt])
}

model VoiceInteraction {
  id        String @id @default(cuid())
  sessionId String

  // Interaction sequence
  sequence Int // Order in conversation
  speaker  String // CUSTOMER | MINA | STAFF

  // Voice data
  audioUrl   String? // Audio file URL
  transcript String // Speech-to-text transcript
  language   String? @default("vi") // Language detected

  // AI processing
  intent    String? // Detected intent
  entities  Json? // Extracted entities (service, stylist, time, etc.)
  sentiment String? // POSITIVE | NEUTRAL | NEGATIVE
  emotion   String? // HAPPY | FRUSTRATED | CURIOUS | etc.

  // Response
  responseText     String? // Mina's response text
  responseAudioUrl String? // Mina's response audio
  responseStyle    String? // FRIENDLY | PROFESSIONAL | TECHNICAL | etc.

  // Timing
  timestamp DateTime @default(now())
  duration  Float? // Audio duration in seconds

  createdAt DateTime @default(now())

  session VoiceSession @relation("SessionInteractions", fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sequence])
  @@index([speaker])
  @@index([intent])
  @@index([timestamp])
}

model VoiceCommand {
  id String @id @default(cuid())

  // Command source
  staffId  String // Staff member who issued command
  branchId String? // Branch context

  // Command data
  audioUrl    String? // Voice command audio
  transcript  String // Command transcript
  commandType String // CHECK_SCHEDULE | VIEW_CUSTOMER | OPEN_SOP | CREATE_PROFILE | etc.

  // Command parameters
  parameters Json? // Extracted parameters
  intent     String // Detected intent

  // Execution
  status String  @default("PENDING") // PENDING | PROCESSING | COMPLETED | FAILED
  result Json? // Command execution result
  error  String? // Error message if failed

  // Response
  responseText     String? // Response text
  responseAudioUrl String? // Response audio

  executedAt DateTime?
  createdAt  DateTime  @default(now())

  @@index([staffId])
  @@index([branchId])
  @@index([commandType])
  @@index([status])
  @@index([createdAt])
}

model VoiceIntent {
  id String @id @default(cuid())

  // Intent classification
  intent     String // BOOKING | PRICE_INQUIRY | SERVICE_ADVICE | CANCEL_BOOKING | etc.
  confidence Float // 0-1 confidence score

  // Context
  sessionId     String?
  interactionId String?

  // Extracted entities
  entities Json? // { service: "uốn nóng", stylist: "Hải", date: "thứ 7", time: "chiều" }

  // Resolution
  resolved         Boolean @default(false)
  resolutionAction String? // Action taken
  bookingId        String? // Created booking ID if applicable

  createdAt DateTime @default(now())

  @@index([intent])
  @@index([sessionId])
  @@index([interactionId])
  @@index([confidence])
}

model VoiceAnalytics {
  id String @id @default(cuid())

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // DAILY | WEEKLY | MONTHLY

  // Metrics
  totalSessions     Int    @default(0)
  totalInteractions Int    @default(0)
  avgDuration       Float? // Average session duration
  avgInteractions   Float? // Average interactions per session

  // Intent breakdown
  intentCounts Json? // { BOOKING: 45, PRICE_INQUIRY: 23, ... }

  // Resolution metrics
  resolutionRate Float? // % of sessions resolved
  bookingRate    Float? // % of sessions that resulted in booking

  // Sentiment analysis
  avgSentiment Float? // Average sentiment score
  positiveRate Float? // % of positive interactions

  // Customer satisfaction
  satisfactionScore Float? // Customer satisfaction score

  // Phone call metrics
  totalCalls      Int    @default(0)
  avgCallDuration Float? // Average call duration
  transferRate    Float? // % of calls transferred to human

  // Voice command metrics
  totalCommands      Int    @default(0)
  commandSuccessRate Float? // % of successful commands

  // Branch/Partner context
  branchId  String?
  partnerId String?

  createdAt DateTime @default(now())

  @@index([periodStart])
  @@index([periodType])
  @@index([branchId])
  @@index([partnerId])
}

// ============================================
// PHASE 29 - AI IMAGE-TO-FORMULA ENGINE
// ============================================

model HairStyleImage {
  id String @id @default(cuid())

  // Image info
  imageUrl     String // URL to uploaded image
  imageType    String  @default("HAIR_STYLE") // HAIR_STYLE | REFERENCE | CUSTOMER_PHOTO
  thumbnailUrl String? // Thumbnail URL

  // Upload context
  customerId String? // If linked to customer
  staffId    String? // Who uploaded
  branchId   String? // Branch context
  partnerId  String? // Partner context

  // Metadata
  originalFileName String?
  fileSize         Int? // File size in bytes
  mimeType         String? // image/jpeg, image/png, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  styleAnalysis HairStyleAnalysis?
  curlAnalysis  CurlPatternAnalysis?
  colorAnalysis ColorAnalysis?
  formulas      HairFormula[]

  @@index([customerId])
  @@index([staffId])
  @@index([branchId])
  @@index([partnerId])
  @@index([imageType])
}

model HairStyleAnalysis {
  id      String @id @default(cuid())
  imageId String @unique

  // Style details
  styleType String? // LAYER | BOB | LONG_WAVE | SHORT_CROP | PIXIE | etc.
  length    String? // SHORT | MEDIUM | LONG | EXTRA_LONG
  lengthCm  Float? // Estimated length in cm

  // Texture & Volume
  texture       String? // SOFT | THICK | FINE | COARSE | MIXED
  hairThickness String? // THIN | MEDIUM | THICK
  volumeTop     String? // LOW | MEDIUM | HIGH
  volumeSide    String? // LOW | MEDIUM | HIGH

  // Condition
  shineLevel  Float? // 0-100
  dryness     Float? // 0-100 (%)
  damageLevel Float? // 0-100 (%)
  porosity    String? // LOW | MEDIUM | HIGH

  // Color basic
  colorLevel   Int? // 1-10 (1 = black, 10 = lightest)
  baseTone     String? // WARM | COOL | NEUTRAL
  overallColor String? // Color description

  // Pattern
  existingPattern String? // Current curl/pattern description

  // AI Analysis
  aiDescription String? // Full AI description
  confidence    Float? // Confidence score 0-1

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image HairStyleImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([styleType])
  @@index([colorLevel])
}

model CurlPatternAnalysis {
  id      String @id @default(cuid())
  imageId String @unique

  // Curl pattern detection
  curlPattern     String? // 3.0 | 3.2 | 3.5 | 3.8 | 4.0 | SPRING | C_CURL | S_CURL | STRAIGHT
  curlPatternDesc String? // Description of curl pattern

  // Curl characteristics
  bounce        String? // LOW | MEDIUM | HIGH
  density       String? // SPARSE | BALANCED | DENSE
  curlDirection String? // UNIFORM | MIXED | RANDOM

  // Measurements
  curlSize      Float? // Average curl size in cm
  curlTightness String? // LOOSE | MEDIUM | TIGHT

  // Distribution
  curlDistribution Json? // How curls are distributed across the head

  // AI Analysis
  aiDescription String?
  confidence    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image HairStyleImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([curlPattern])
}

model ColorAnalysis {
  id      String @id @default(cuid())
  imageId String @unique

  // Base tone
  baseLevel Int? // 1-10
  baseTone  String? // WARM | COOL | NEUTRAL
  baseColor String? // Color name

  // Mid tone
  midLevel Int?
  midTone  String?
  midColor String?

  // End tone
  endLevel Int?
  endTone  String?
  endColor String?

  // Highlights
  hasHighlights         Boolean @default(false)
  highlightLevel        Int?
  highlightTone         String?
  highlightColor        String?
  highlightDistribution String? // BALAYAGE | FOIL | FULL_HEAD

  // Overall color
  undertone        String? // WARM | COOL | NEUTRAL | OLIVE | PINK
  saturation       Float? // 0-100
  lightness        Float? // 0-100
  overallColorDesc String? // Overall color description

  // Color technique detected
  technique String? // SOLID | OMBRE | BALAYAGE | HIGHLIGHT | BABYLIGHT | FOILAYAGE

  // AI Analysis
  aiDescription String?
  confidence    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image HairStyleImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([baseLevel])
  @@index([technique])
}

model HairFormula {
  id      String @id @default(cuid())
  imageId String

  // Formula type
  formulaType String // PERM_HOT | PERM_COLD | PERM_ACID | COLOR | BOTH

  // Perm formula
  permProduct  String? // Plexis product name
  permStrength String? // S1 | S2 | Acid | etc.
  permSetting  String? // Setting size (3.2, 3.5, etc.)
  permTime     Int? // Processing time in minutes
  permHeat     Float? // Temperature in Celsius
  permSteps    Json? // Step-by-step procedure

  // Color formula
  colorTubes Json? // Array of {tube: "7NB", parts: 6}
  colorOxy   Json? // {strength: "6%", parts: 1.5}
  colorTime  Int? // Processing time in minutes
  colorSteps Json? // Step-by-step procedure

  // Pre-treatment
  preTreatment String? // Pre-treatment recommendations

  // Post-treatment
  postTreatment String? // Post-treatment recommendations

  // Warnings & Notes
  warnings String[] // Array of warnings
  notes    String[] // Additional notes

  // Risk assessment
  riskLevel   String? // LOW | MEDIUM | HIGH
  riskFactors String[] // Risk factors identified

  // AI Generated
  aiGenerated Boolean @default(true)
  confidence  Float? // Confidence score

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  image HairStyleImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([imageId])
  @@index([formulaType])
  @@index([riskLevel])
}

model HairProcedure {
  id      String @id @default(cuid())
  imageId String

  // Analysis references
  styleAnalysisId String?
  curlAnalysisId  String?
  colorAnalysisId String?
  formulaId       String?

  // Complete procedure
  procedureType String // PERM | COLOR | BOTH | CUT

  // Full procedure steps
  preProcedure  Json? // Pre-procedure steps
  mainProcedure Json // Main procedure steps (required)
  postProcedure Json? // Post-procedure steps

  // Product recommendations
  products Json? // Recommended products

  // Estimated time
  estimatedTime Int? // Total time in minutes

  // Aftercare
  aftercare Json? // Aftercare instructions

  // Complete SOP text
  fullSOP String? // Complete SOP in text format

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([imageId])
  @@index([procedureType])
}

// ============================================
// PHASE 30 - AI VIDEO HAIR ANALYSIS
// ============================================

model HairAnalysisVideo {
  id String @id @default(cuid())

  // Video info
  videoUrl     String // URL to uploaded video
  thumbnailUrl String? // Thumbnail URL
  videoType    String  @default("HAIR_ANALYSIS") // HAIR_ANALYSIS | ELASTICITY_TEST | MOVEMENT_TEST

  // Video metadata
  duration   Float? // Duration in seconds
  frameCount Int? // Total frames extracted
  fps        Float? // Frames per second
  resolution String? // Video resolution (e.g., "1920x1080")
  fileSize   Int? // File size in bytes
  mimeType   String? // video/mp4, video/mov, etc.

  // Upload context
  customerId String? // If linked to customer
  staffId    String? // Who uploaded/recorded
  branchId   String? // Branch context
  partnerId  String? // Partner context
  bookingId  String? // If linked to booking

  // Original filename
  originalFileName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  frames             VideoFrame[]
  movementAnalysis   HairMovementAnalysis?
  elasticityAnalysis HairElasticityAnalysis?
  surfaceAnalysis    HairSurfaceAnalysis?
  damageMapping      HairDamageMapping?
  recommendation     HairVideoRecommendation?

  @@index([customerId])
  @@index([staffId])
  @@index([branchId])
  @@index([bookingId])
  @@index([videoType])
}

model VideoFrame {
  id      String @id @default(cuid())
  videoId String

  // Frame info
  frameNumber Int // Frame sequence number
  timestamp   Float // Timestamp in seconds
  imageUrl    String // Extracted frame image URL

  // Frame analysis
  analyzed     Boolean @default(false)
  analysisData Json? // Frame-specific analysis data

  createdAt DateTime @default(now())

  video HairAnalysisVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([frameNumber])
  @@index([timestamp])
}

model HairMovementAnalysis {
  id      String @id @default(cuid())
  videoId String @unique

  // Movement scores
  movementScore Float? // 0-100 overall movement quality
  bounceScore   Float? // 0-100 bounce/springiness
  frizzScore    Float? // 0-100 (lower = less frizz)
  fiberCohesion Float? // 0-100 (how well fibers stick together)
  softnessScore Float? // 0-100 (soft vs hard)

  // Movement characteristics
  movementType        String? // SMOOTH | CHOPPY | RIGID | FLUID
  bounceLevel         String? // LOW | MEDIUM | HIGH
  frizzLevel          String? // LOW | MEDIUM | HIGH
  densityDistribution Json? // Thickness at different parts

  // Hair interaction
  fiberInteraction String? // STABLE | UNSTABLE | CLUMPED | SEPARATED

  // AI Analysis
  aiDescription String? // Full AI description
  confidence    Float? // Confidence score

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  video HairAnalysisVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([movementScore])
  @@index([bounceScore])
}

model HairElasticityAnalysis {
  id      String @id @default(cuid())
  videoId String @unique

  // Elasticity metrics
  stretchPercent  Float? // Stretch percentage (0-100)
  snapbackRate    Float? // How fast it returns (0-100)
  elasticityScore Float? // Overall elasticity score (0-100)

  // Risk assessment
  gumHairRisk  String? // LOW | MEDIUM | HIGH (risk of "gum hair")
  breakageRisk String? // LOW | MEDIUM | HIGH
  damageRisk   String? // LOW | MEDIUM | HIGH

  // Test results
  testType        String? // MANUAL_STRETCH | AUTOMATED | VISUAL
  stretchDistance Float? // Distance stretched in cm
  recoveryTime    Float? // Time to recover in seconds

  // Elasticity status
  elasticityStatus String? // HEALTHY | MODERATE | POOR | CRITICAL

  // AI Analysis
  aiDescription   String?
  recommendations String[] // Recommendations based on elasticity
  confidence      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  video HairAnalysisVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([elasticityScore])
  @@index([damageRisk])
}

model HairSurfaceAnalysis {
  id      String @id @default(cuid())
  videoId String @unique

  // Surface metrics
  shineLevel    Float? // 0-100 (shininess)
  porosityLevel String? // LOW | MEDIUM | HIGH
  drynessLevel  Float? // 0-100 (% dryness)

  // Light analysis
  lightAbsorption Float? // 0-100 (how much light absorbed)
  lightReflection Float? // 0-100 (how much light reflected)
  colorUptake     Float? // 0-100 (predicted color absorption)

  // Texture indicators
  smoothnessScore Float? // 0-100 (surface smoothness)
  roughnessScore  Float? // 0-100 (surface roughness)

  // Condition assessment
  surfaceCondition String? // EXCELLENT | GOOD | FAIR | POOR | CRITICAL

  // AI Analysis
  aiDescription String?
  confidence    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  video HairAnalysisVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([shineLevel])
  @@index([porosityLevel])
  @@index([drynessLevel])
}

model HairDamageMapping {
  id      String @id @default(cuid())
  videoId String @unique

  // Damage zones
  damageZones Json? // Array of damage zones with percentages
  // Format: [{zone: "ends", percentage: 28, severity: "SEVERE", type: "BURNED"}, ...]

  // Overall damage
  overallDamage Float? // Overall damage percentage (0-100)
  damageLevel   String? // NONE | MILD | MODERATE | SEVERE | CRITICAL

  // Damage types detected
  damageTypes String[] // BURNED | DRY | BREAKAGE | SPLIT_ENDS | COLOR_DAMAGE | etc.

  // Zone breakdown
  endsDamage  Float? // Damage at ends (%)
  midDamage   Float? // Damage at mid-length (%)
  rootDamage  Float? // Damage at roots (%)
  crownDamage Float? // Damage at crown (%)
  sidesDamage Float? // Damage at sides (%)

  // Severity by zone
  endsSeverity String? // NONE | MILD | MODERATE | SEVERE | CRITICAL
  midSeverity  String?
  rootSeverity String?

  // Damage visualization
  damageMapUrl String? // URL to damage visualization map

  // AI Analysis
  aiDescription String?
  confidence    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  video HairAnalysisVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([overallDamage])
  @@index([damageLevel])
}

model HairVideoRecommendation {
  id      String @id @default(cuid())
  videoId String @unique

  // Overall assessment
  hairHealthScore Float? // 0-100 overall hair health
  healthStatus    String? // EXCELLENT | GOOD | FAIR | POOR | CRITICAL

  // Service suitability
  permHotSuitable    Boolean? // Can perm hot be done?
  permColdSuitable   Boolean? // Can perm cold be done?
  permAcidSuitable   Boolean? // Can perm acid be done?
  colorLightSuitable Boolean? // Can light color be done?
  colorDarkSuitable  Boolean? // Can dark color be done?

  // Risk assessment
  overallRisk String? // LOW | MEDIUM | HIGH | CRITICAL
  riskFactors String[] // Array of risk factors

  // Product recommendations
  recommendedProducts String[] // Recommended products

  // Technique recommendations
  recommendedTechniques String[] // Recommended techniques

  // Treatment plan
  treatmentPlan Json? // Pre-treatment plan if needed
  recoveryPlan  Json? // Recovery plan if damaged

  // Formula suggestions
  permFormula  Json? // Suggested perm formula
  colorFormula Json? // Suggested color formula

  // Full recommendation text
  fullRecommendation String? // Complete recommendation in text

  // AI Analysis
  aiDescription String?
  confidence    Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  video HairAnalysisVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([hairHealthScore])
  @@index([healthStatus])
  @@index([overallRisk])
}

// ============================================
// PHASE 31 - MINA PERSONALIZATION ENGINE
// ============================================

model CustomerPersonalityProfile {
  id         String @id @default(cuid())
  customerId String @unique

  // Hair Preferences
  curlPreference   String? // LOOSE | MEDIUM | TIGHT | STRAIGHT
  lengthPreference String? // SHORT | MEDIUM | LONG | EXTRA_LONG
  stylePreference  String? // NATURAL | GLAM | CASUAL | ELEGANT

  // Color Preferences
  colorPreference          String[] // Array of preferred colors (e.g., ["brown", "mocha", "beige"])
  colorTonePreference      String? // WARM | COOL | NEUTRAL
  colorIntensityPreference String? // LIGHT | MEDIUM | DARK

  // Style Vibe
  styleVibe   String[] // FEMININE | MINIMAL | SEDUCTIVE | YOUTHFUL | KOREAN | MATURE
  personality String? // GENTLE | BOLD | ELEGANT | CASUAL | SOPHISTICATED

  // Habits
  hairCareHabits String[] // LOW_MAINTENANCE | HEAT_STYLING | FREQUENT_DYEING | NEGLECTFUL
  lifestyle      String? // BUSY | RELAXED | ACTIVE

  // Communication Style
  communicationStyle String? // QUIET | CHATTY | DETAIL_ORIENTED | DECISIVE
  followUpPreference String? // SHORT | DETAILED | REMINDER_HEAVY

  // AI Analysis
  personalitySummary String? // AI-generated summary
  aestheticProfile   Json? // Detailed aesthetic profile
  preferencesScore   Json? // Preference confidence scores

  // Learning data
  interactionsCount Int      @default(0) // Number of interactions with Mina
  lastUpdated       DateTime @updatedAt
  createdAt         DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([styleVibe])
}

model StylistSignatureStyle {
  id      String @id @default(cuid())
  staffId String @unique

  // Expertise areas
  specialties String[] // PERM_HOT | PERM_COLD | COLOR_COLD | COLOR_WARM | BOB | LAYER | etc.

  // Style characteristics
  preferredCurlSize   String[] // ["3.2", "3.5", "3.8"] - Preferred curl sizes
  preferredColorTones String[] // Preferred color tones
  preferredTechniques String[] // Preferred techniques

  // Signature traits
  signatureStyle String? // Description of signature style
  styleStrength  Json? // Strength in different areas
  typicalResults Json? // Typical results achieved

  // Customer feedback
  averageRating        Float? // Average customer rating
  customerSatisfaction Float? // Overall satisfaction

  // AI-learned patterns
  commonFormulas    Json? // Common formulas used
  successfulStyles  Json? // Most successful styles
  preferredSettings Json? // Preferred settings/parameters

  // Learning data
  servicesCount Int      @default(0) // Number of services performed
  lastAnalyzed  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  staff User @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([specialties])
}

model PersonalizedRecommendation {
  id         String  @id @default(cuid())
  customerId String
  stylistId  String? // Recommended stylist

  // Recommendation context
  recommendationType String // STYLE | COLOR | TREATMENT | PRODUCT | SERVICE
  priority           Int    @default(0) // Priority score (higher = more relevant)

  // Recommendation details
  recommendedStyle    String? // Style name
  recommendedColor    String? // Color name
  recommendedService  String? // Service name
  recommendedProducts String[] // Recommended products

  // Reasoning
  reasoning              String? // Why this recommendation
  personalizationFactors Json? // Factors that led to this recommendation
  confidence             Float? // Confidence score 0-1

  // Match scores
  customerMatchScore Float? // How well it matches customer preferences
  stylistMatchScore  Float? // How well stylist can execute

  // AI generated
  aiGenerated     Boolean @default(true)
  fullExplanation String? // Full explanation for customer

  // Status
  status      String    @default("ACTIVE") // ACTIVE | ACCEPTED | REJECTED | EXPIRED
  presentedAt DateTime? // When presented to customer
  acceptedAt  DateTime? // When accepted
  rejectedAt  DateTime? // When rejected

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([stylistId])
  @@index([recommendationType])
  @@index([status])
  @@index([priority])
}

model MinaMemory {
  id         String @id @default(cuid())
  customerId String

  // Memory type
  memoryType String // PREFERENCE | HABIT | FEEDBACK | INTERACTION | PATTERN
  category   String? // Hair preference, color preference, seating, timing, etc.

  // Memory content
  key     String // Memory key (e.g., "prefers_brown_over_cool_brown")
  value   String? // Memory value
  details Json? // Additional details

  // Context
  source   String? // CONVERSATION | BOOKING | SERVICE | FEEDBACK
  sourceId String? // ID of source (booking, service, etc.)

  // Confidence
  confidence     Float @default(0.5) // How confident we are about this memory
  confirmedCount Int   @default(1) // Number of times confirmed

  // Usage
  lastUsed   DateTime? // When this memory was last used
  usageCount Int       @default(0) // How many times used

  // Temporal
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // If memory might expire

  @@index([customerId])
  @@index([memoryType])
  @@index([category])
  @@index([key])
  @@index([lastUsed])
}

model PersonalizedFollowUp {
  id         String  @id @default(cuid())
  customerId String
  bookingId  String? // Related booking
  serviceId  String? // Related service

  // Follow-up type
  followUpType String // POST_SERVICE | REMINDER | CHECK_IN | PROMOTION | CUSTOM
  priority     String @default("MEDIUM") // LOW | MEDIUM | HIGH | URGENT

  // Personalization
  tone    String? // Friendly tone based on customer personality
  length  String? // SHORT | MEDIUM | LONG based on communication style
  content String // Personalized content

  // Timing
  scheduledAt DateTime? // When to send
  sentAt      DateTime? // When sent
  readAt      DateTime? // When read

  // Response
  responseReceived Boolean @default(false)
  responseContent  String? // Customer response

  // Status
  status String @default("PENDING") // PENDING | SENT | READ | RESPONDED | CANCELLED

  // AI generated
  aiGenerated            Boolean @default(true)
  personalizationFactors Json? // Factors used for personalization

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([bookingId])
  @@index([followUpType])
  @@index([status])
  @@index([scheduledAt])
}

model PersonalizationMetric {
  id         String @id @default(cuid())
  customerId String

  // Metrics
  personalizationScore   Float? // Overall personalization score (0-100)
  recommendationAccuracy Float? // How accurate recommendations are
  customerSatisfaction   Float? // Satisfaction with personalization

  // Usage metrics
  recommendationsReceived Int @default(0)
  recommendationsAccepted Int @default(0)
  recommendationsRejected Int @default(0)

  // Engagement metrics
  minaInteractions  Int    @default(0) // Total interactions with Mina
  followUpResponses Int    @default(0) // Responses to follow-ups
  bookingFrequency  Float? // Bookings per month

  // Preference evolution
  preferencesUpdated   Int       @default(0) // Times preferences updated
  lastPreferenceUpdate DateTime?

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // WEEKLY | MONTHLY | QUARTERLY | YEARLY

  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([periodStart])
  @@index([periodType])
}

model CustomerStyleHistory {
  id         String  @id @default(cuid())
  customerId String
  bookingId  String?
  serviceId  String?

  // Style details
  styleName   String? // Style name
  styleType   String? // PERM | COLOR | CUT | TREATMENT
  curlPattern String? // Curl pattern if perm
  colorTone   String? // Color tone if color
  length      String? // Length after service

  // Preferences expressed
  customerFeedback String? // Customer feedback about style
  likedFeatures    String[] // Features customer liked
  dislikedFeatures String[] // Features customer didn't like

  // Outcome
  satisfaction Float? // Customer satisfaction (0-100)
  returnIntent Boolean? // Did customer want to return

  // Used for learning
  usedForLearning Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([bookingId])
  @@index([styleType])
  @@index([createdAt])
}

// ============================================
// PHASE 32 - FINANCIAL MODULE & PROFIT CONTROL
// ============================================

model Revenue {
  id String @id @default(cuid())

  // Revenue details
  date          DateTime @default(now())
  amount        Float // Revenue amount in VND
  source        String // SERVICE | PRODUCT | COMBO | UPSELL | TIPS | PARTNER_FEE | PREPAYMENT
  paymentMethod String? // CASH | CARD | BANK_TRANSFER | E_WALLET
  currency      String   @default("VND")

  // Context
  branchId   String? // Branch context
  partnerId  String? // Partner context (if franchise fee)
  customerId String? // Customer who paid
  staffId    String? // Staff who generated revenue

  // Source details
  serviceId String? // If from service
  invoiceId String? // Related invoice
  bookingId String? // Related booking
  productId String? // If from product sale

  // Metadata
  description String? // Description
  notes       String? // Additional notes
  receiptUrl  String? // Receipt/invoice image

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([branchId])
  @@index([partnerId])
  @@index([source])
  @@index([staffId])
}

model Expense {
  id String @id @default(cuid())

  // Expense details
  date        DateTime @default(now())
  amount      Float // Expense amount in VND
  category    String // PRODUCT | STAFF | UTILITY | RENT | MARKETING | TRAINING | DEPRECIATION | OPERATION | TOOLS_SUPPLIES
  subCategory String? // Sub-category for detailed tracking
  description String // Description
  currency    String   @default("VND")

  // Context
  branchId  String? // Branch context
  partnerId String? // Partner context

  // Payment details
  paymentMethod String? // CASH | CARD | BANK_TRANSFER
  vendor        String? // Vendor/supplier name

  // Documentation
  receiptUrl    String? // Receipt/invoice image
  invoiceNumber String? // Invoice number

  // Approval
  approvedBy String? // User ID who approved
  approvedAt DateTime?
  status     String    @default("PENDING") // PENDING | APPROVED | REJECTED

  // Recurring
  isRecurring     Boolean @default(false)
  recurringPeriod String? // MONTHLY | WEEKLY | DAILY | YEARLY

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
  @@index([branchId])
  @@index([category])
  @@index([status])
}

model COGSCalculation {
  id String @id @default(cuid())

  // Context
  serviceId String? // Service context
  bookingId String? // Booking context
  invoiceId String? // Invoice context

  // Product usage
  productsUsed Json // Array of {productId, quantity, unitCost, totalCost}

  // Calculation
  totalCOGS Float // Total cost of goods sold
  quantity  Float? // Quantity/units

  // Per-unit calculation
  cogsPerUnit Float? // COGS per service unit

  // Details
  date     DateTime @default(now())
  branchId String? // Branch context
  staffId  String? // Staff who performed service

  createdAt DateTime @default(now())

  @@index([date])
  @@index([serviceId])
  @@index([branchId])
}

model ProfitCalculation {
  id String @id @default(cuid())

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // DAILY | WEEKLY | MONTHLY | QUARTERLY | YEARLY

  // Context
  branchId  String? // Branch-specific or null for all branches
  partnerId String? // Partner-specific or null for all

  // Revenue
  totalRevenue Float @default(0)

  // COGS
  totalCOGS Float @default(0)

  // Operating Expenses
  operatingExpenses Float @default(0) // Staff, utility, rent, etc.

  // Gross Profit
  grossProfit Float  @default(0)
  grossMargin Float? // Gross margin percentage

  // Operating Profit
  operatingProfit Float  @default(0)
  operatingMargin Float? // Operating margin percentage

  // Net Profit
  netProfit Float  @default(0)
  netMargin Float? // Net margin percentage

  // Other metrics
  ebitda         Float? // EBITDA
  breakEvenPoint Float? // Break-even point

  // Breakdown
  expenseBreakdown Json? // Breakdown by category
  revenueBreakdown Json? // Breakdown by source

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([periodStart])
  @@index([periodType])
  @@index([branchId])
  @@index([partnerId])
}

model Cashflow {
  id String @id @default(cuid())

  // Date
  date DateTime @default(now())

  // Inflow (tiền vào)
  totalInflow     Float @default(0)
  inflowBreakdown Json? // Breakdown by source

  // Outflow (tiền ra)
  totalOutflow     Float @default(0)
  outflowBreakdown Json? // Breakdown by category

  // Net cashflow
  netCashflow Float // totalInflow - totalOutflow

  // Balance
  openingBalance Float? // Opening balance
  closingBalance Float? // Closing balance

  // Context
  branchId  String? // Branch context
  partnerId String? // Partner context

  // Payment methods
  cashAmount     Float? @default(0)
  cardAmount     Float? @default(0)
  transferAmount Float? @default(0)
  eWalletAmount  Float? @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date, branchId])
  @@index([date])
  @@index([branchId])
}

model FinancialForecast {
  id String @id @default(cuid())

  // Forecast period
  forecastDate DateTime // Date of forecast
  periodStart  DateTime // Forecast period start
  periodEnd    DateTime // Forecast period end
  periodType   String // MONTHLY | QUARTERLY | YEARLY

  // Forecasted values
  forecastRevenue  Float? // Forecasted revenue
  forecastExpenses Float? // Forecasted expenses
  forecastProfit   Float? // Forecasted profit

  // Forecast details
  forecastBreakdown Json? // Detailed forecast breakdown

  // Confidence
  confidence Float? // Forecast confidence (0-1)

  // Factors
  factors     Json? // Factors influencing forecast
  assumptions Json? // Assumptions made

  // Context
  branchId  String? // Branch-specific forecast
  partnerId String? // Partner-specific forecast

  // AI Analysis
  aiAnalysis      String? // AI analysis text
  recommendations String[] // Recommendations

  createdAt DateTime @default(now())

  @@index([forecastDate])
  @@index([periodStart])
  @@index([periodType])
}

model FinancialRiskAlert {
  id String @id @default(cuid())

  // Alert type
  alertType String // COGS_INCREASE | REVENUE_DECREASE | EXPENSE_SPIKE | LOSS_MARGIN | WASTAGE_HIGH | STAFF_COST_HIGH | MARKETING_INEFFICIENT | UPSELL_DECREASE

  // Severity
  severity String // LOW | MEDIUM | HIGH | CRITICAL

  // Alert details
  title         String
  message       String
  currentValue  Float? // Current value
  previousValue Float? // Previous value
  changePercent Float? // Percentage change

  // Context
  branchId    String? // Branch-specific alert
  partnerId   String? // Partner-specific alert
  periodStart DateTime
  periodEnd   DateTime

  // Recommendations
  recommendations String[] // AI-generated recommendations

  // Status
  status         String    @default("ACTIVE") // ACTIVE | ACKNOWLEDGED | RESOLVED
  acknowledgedBy String? // User ID
  acknowledgedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([alertType])
  @@index([severity])
  @@index([status])
  @@index([createdAt])
}

model FinancialMetric {
  id String @id @default(cuid())

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // DAILY | WEEKLY | MONTHLY | QUARTERLY | YEARLY

  // Key metrics
  totalRevenue  Float @default(0)
  totalExpenses Float @default(0)
  totalCOGS     Float @default(0)
  grossProfit   Float @default(0)
  netProfit     Float @default(0)

  // Margins
  grossMargin Float? // %
  netMargin   Float? // %

  // Additional metrics
  avgTransactionValue Float? // Average transaction value
  customerCount       Int? // Number of customers
  servicesCount       Int? // Number of services

  // Context
  branchId  String? // Branch-specific
  partnerId String? // Partner-specific

  createdAt DateTime @default(now())

  @@index([periodStart])
  @@index([periodType])
  @@index([branchId])
  @@index([partnerId])
}

// ============================================
// PHASE 33 - DYNAMIC PRICING ENGINE
// ============================================

model PricingRule {
  id String @id @default(cuid())

  // Rule type
  ruleType String // TIME_BASED | DEMAND_BASED | STYLIST_LEVEL | PEAK_HOUR | SEASONAL
  ruleName String // Human-readable name
  priority Int    @default(0) // Higher priority = applied first

  // Conditions
  conditions Json // Conditions for rule to apply
  // Examples:
  // { timeRange: ["14:00", "18:00"], daysOfWeek: [6], serviceIds: ["service_id"] }
  // { demandLevel: "HIGH", serviceIds: [...] }
  // { stylistLevel: "MASTER", stylistIds: [...] }

  // Adjustment
  adjustmentType      String // PERCENTAGE | FIXED_AMOUNT
  adjustmentValue     Float // Percentage (e.g., 8) or fixed amount (e.g., 50000)
  adjustmentDirection String // INCREASE | DECREASE

  // Scope
  serviceIds String[] // Which services this applies to (empty = all)
  branchIds  String[] // Which branches (empty = all)
  stylistIds String[] // Which stylists (empty = all)

  // Validity
  startDate DateTime? // When rule starts
  endDate   DateTime? // When rule ends
  isActive  Boolean   @default(true)

  // Metadata
  description String?
  createdBy   String? // User ID who created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ruleType])
  @@index([isActive])
  @@index([priority])
}

model DynamicPricing {
  id String @id @default(cuid())

  // Context
  serviceId String
  branchId  String?
  stylistId String?

  // Pricing
  basePrice         Float // Original/base price
  adjustedPrice     Float // Price after adjustments
  adjustmentAmount  Float @default(0) // Total adjustment
  adjustmentPercent Float @default(0) // Total adjustment %

  // Applied rules
  appliedRules String[] // IDs of pricing rules applied

  // Context data
  timeSlot     String? // Time slot (e.g., "14:00-18:00")
  dayOfWeek    Int? // 0-6 (Sunday-Saturday)
  demandLevel  String? // LOW | NORMAL | HIGH | VERY_HIGH
  trafficLevel String? // LOW | NORMAL | HIGH | VERY_HIGH

  // Validity
  effectiveFrom  DateTime  @default(now())
  effectiveUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([serviceId])
  @@index([branchId])
  @@index([stylistId])
  @@index([effectiveFrom])
}

model PeakHourDetection {
  id String @id @default(cuid())

  // Date & Time
  date      DateTime @default(now())
  timeSlot  String // e.g., "14:00-15:00"
  dayOfWeek Int // 0-6

  // Traffic metrics
  bookingCount      Int @default(0) // Bookings in this slot
  waitingCustomers  Int @default(0) // Customers waiting
  availableSeats    Int @default(0) // Available seats
  availableStylists Int @default(0) // Available stylists
  totalStylists     Int @default(0) // Total stylists

  // Online traffic
  onlineInquiries Int @default(0) // Inbox/chat inquiries
  pageViews       Int @default(0) // Website/page views

  // Calculated level
  trafficLevel String // LOW | NORMAL | HIGH | VERY_HIGH
  peakScore    Float  @default(0) // 0-100 peak score

  // Context
  branchId   String? // Branch context
  serviceIds String[] // Services being viewed/requested

  createdAt DateTime @default(now())

  @@index([date])
  @@index([timeSlot])
  @@index([trafficLevel])
  @@index([branchId])
}

model SmartDiscount {
  id String @id @default(cuid())

  // Discount type
  discountType String // TIME_BASED | SERVICE_BASED | COMBO | FLASH_SALE | SEASONAL
  discountName String // Human-readable name

  // Discount details
  discountValue Float // Discount amount or percentage
  discountUnit  String // PERCENTAGE | FIXED_AMOUNT
  minPurchase   Float? // Minimum purchase required

  // Scope
  serviceIds       String[] // Services this discount applies to
  branchIds        String[] // Branches
  customerSegments String[] // Customer segments (e.g., ["NEW", "VIP"])

  // Validity
  startTime DateTime
  endTime   DateTime
  isActive  Boolean  @default(true)

  // Conditions
  conditions Json? // Additional conditions
  // e.g., { minBookingHours: 24, maxUses: 100 }

  // Tracking
  usageCount    Int    @default(0) // How many times used
  maxUsage      Int? // Max usage limit
  revenueImpact Float? // Revenue impact tracking

  // AI generated
  aiGenerated Boolean @default(false)
  aiReasoning String? // Why this discount was created

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([discountType])
  @@index([isActive])
  @@index([startTime])
  @@index([endTime])
}

model PricingHistory {
  id String @id @default(cuid())

  // Context
  serviceId String
  branchId  String?
  stylistId String?

  // Price change
  previousPrice Float
  newPrice      Float
  changeAmount  Float
  changePercent Float

  // Reason
  changeReason String? // Reason for price change
  appliedRules String[] // Rule IDs applied

  // Context
  demandLevel  String? // Demand level when changed
  trafficLevel String? // Traffic level when changed

  // Metadata
  changedBy String? // User ID or "AUTO"
  changedAt DateTime @default(now())

  @@index([serviceId])
  @@index([changedAt])
  @@index([branchId])
}

model PricingOptimization {
  id String @id @default(cuid())

  // Optimization period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // DAILY | WEEKLY | MONTHLY

  // Service context
  serviceId String?
  branchId  String?

  // Current vs Optimized
  currentRevenue         Float @default(0)
  optimizedRevenue       Float @default(0)
  revenueIncrease        Float @default(0)
  revenueIncreasePercent Float @default(0)

  // Current vs Optimized prices
  currentAvgPrice   Float? // Current average price
  optimizedAvgPrice Float? // Optimized average price

  // Optimization factors
  optimizationFactors Json? // Factors considered

  // Recommendations
  recommendations Json? // Pricing recommendations
  expectedImpact  Json? // Expected impact analysis

  // AI Analysis
  aiAnalysis String? // AI analysis text

  createdAt DateTime @default(now())

  @@index([periodStart])
  @@index([serviceId])
  @@index([branchId])
}

// ============================================
// PHASE 34 - MEMBERSHIP & LOYALTY SYSTEM
// ============================================

model MembershipTier {
  id String @id @default(cuid())

  // Tier info
  tierLevel String @unique // MEMBER | SILVER | GOLD | DIAMOND
  tierName  String // Display name
  tierOrder Int    @default(0) // For sorting

  // Requirements
  minSpending  Float  @default(0) // Minimum spending in VND for this tier
  periodMonths Int    @default(12) // Period to calculate spending (6 or 12 months)
  minVisits    Int? // Minimum visits required
  minLTV       Float? // Minimum LTV required

  // Point multiplier
  pointMultiplier Float @default(1.0) // Points multiplier (e.g., 1.2x, 1.5x, 2.0x)

  // Benefits (stored as JSON for flexibility)
  benefits Json // { serviceDiscount: 0, productDiscount: 0, ... }

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tierLevel])
  @@index([tierOrder])
}

model CustomerMembership {
  id         String @id @default(cuid())
  customerId String @unique

  // Current tier
  currentTier String @default("MEMBER") // MEMBER | SILVER | GOLD | DIAMOND

  // Spending tracking
  totalSpending  Float     @default(0) // Total lifetime spending
  periodSpending Float     @default(0) // Spending in current period
  periodStart    DateTime? // Start of current period
  periodEnd      DateTime? // End of current period

  // Visit tracking
  totalVisits  Int @default(0)
  periodVisits Int @default(0)

  // Points
  currentPoints  Float @default(0) // Current available points
  lifetimePoints Float @default(0) // Total points earned
  pointsRedeemed Float @default(0) // Total points redeemed

  // Status
  status String @default("ACTIVE") // ACTIVE | SUSPENDED | EXPIRED

  // Dates
  joinedAt       DateTime  @default(now())
  tierUpgradedAt DateTime? // Last tier upgrade date
  lastVisitAt    DateTime? // Last visit date
  expiresAt      DateTime? // Membership expiration (if applicable)

  customer           Customer             @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tierUpgradeHistory TierUpgradeHistory[]
  rewardRedemptions  RewardRedemption[]
  pointsTransactions PointsTransaction[]

  @@index([customerId])
  @@index([currentTier])
  @@index([status])
}

model PointsTransaction {
  id           String @id @default(cuid())
  customerId   String
  membershipId String

  // Transaction details
  transactionType String // EARNED | REDEEMED | EXPIRED | ADJUSTED
  points          Float // Points amount (positive for earned, negative for redeemed)

  // Context
  source   String? // SERVICE | PRODUCT | BONUS | REDEMPTION | ADJUSTMENT
  sourceId String? // ID of source (service, product, reward, etc.)

  // Calculation details
  baseAmount       Float? // Base amount spent
  multiplier       Float? // Point multiplier applied
  calculatedPoints Float? // Calculated points before multiplier

  // Description
  description String? // Human-readable description

  // Expiry
  expiresAt DateTime? // When points expire (if applicable)

  createdAt DateTime @default(now())

  membership CustomerMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([membershipId])
  @@index([transactionType])
  @@index([createdAt])
}

model TierUpgradeHistory {
  id           String @id @default(cuid())
  customerId   String
  membershipId String

  // Tier change
  previousTier String
  newTier      String
  changeType   String // UPGRADE | DOWNGRADE | MAINTAIN

  // Reasons
  reason      String? // Reason for change
  triggerType String? // AUTO | MANUAL | REVIEW
  criteria    Json? // Criteria that triggered change

  // Context
  spendingAtChange Float? // Spending at time of change
  visitsAtChange   Int? // Visits at time of change
  pointsAtChange   Float? // Points at time of change

  createdAt DateTime @default(now())

  membership CustomerMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([membershipId])
  @@index([changeType])
  @@index([createdAt])
}

model RewardCatalog {
  id String @id @default(cuid())

  // Reward info
  rewardName  String
  rewardType  String // SERVICE | PRODUCT | DISCOUNT | VOUCHER | GIFT
  rewardValue Float? // Value in VND (for discounts/vouchers)

  // Point cost
  pointsRequired Float // Points needed to redeem

  // Eligibility
  eligibleTiers String[] // Which tiers can redeem (empty = all)

  // Details
  description String?
  imageUrl    String?

  // Limits
  maxRedemptions     Int? // Max times per customer
  maxTotal           Int? // Max total redemptions
  currentRedemptions Int  @default(0)

  // Validity
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  redemptions RewardRedemption[]

  @@index([rewardType])
  @@index([isActive])
  @@index([pointsRequired])
}

model RewardRedemption {
  id           String @id @default(cuid())
  customerId   String
  membershipId String
  rewardId     String

  // Redemption details
  pointsUsed Float // Points used for redemption
  status     String @default("PENDING") // PENDING | COMPLETED | CANCELLED | EXPIRED

  // Context
  bookingId String? // If redeemed as part of booking
  serviceId String? // If service reward

  // Usage
  usedAt    DateTime? // When reward was used
  expiresAt DateTime? // When reward expires

  // Notes
  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  membership CustomerMembership @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  reward     RewardCatalog      @relation(fields: [rewardId], references: [id])

  @@index([customerId])
  @@index([membershipId])
  @@index([rewardId])
  @@index([status])
}

model LoyaltyPrediction {
  id         String @id @default(cuid())
  customerId String

  // Prediction type
  predictionType String // RETURN_LIKELIHOOD | TIER_CHANGE | CHURN_RISK | UPGRADE_POTENTIAL

  // Prediction score
  score Float // 0-100 score

  // Details
  predictedValue String? // Predicted outcome
  confidence     Float? // Confidence level (0-1)

  // Timeline
  predictedDate DateTime? // When prediction is expected

  // Factors
  factors Json? // Factors influencing prediction

  // AI Analysis
  aiAnalysis String? // AI-generated analysis

  // Status
  status String @default("ACTIVE") // ACTIVE | CONFIRMED | INVALIDATED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([predictionType])
  @@index([score])
  @@index([status])
}

model MembershipMetric {
  id String @id @default(cuid())

  // Time period
  periodStart DateTime
  periodEnd   DateTime
  periodType  String // DAILY | WEEKLY | MONTHLY | QUARTERLY | YEARLY

  // Tier metrics
  tier String // Tier level

  // Metrics
  memberCount   Int   @default(0) // Number of members in this tier
  totalSpending Float @default(0) // Total spending
  avgSpending   Float @default(0) // Average spending per member
  avgLTV        Float @default(0) // Average LTV

  // Activity
  totalVisits   Int    @default(0)
  avgVisits     Float  @default(0)
  retentionRate Float? // Retention rate

  // Tier changes
  upgrades   Int @default(0) // Upgrades to this tier
  downgrades Int @default(0) // Downgrades from this tier

  createdAt DateTime @default(now())

  @@index([periodStart])
  @@index([periodType])
  @@index([tier])
}

///////////////////////////////////////////////////////////////
// PHASE 8 - SAAS SUBSCRIPTION SYSTEM
///////////////////////////////////////////////////////////////

model Plan {
  id          String           @id @default(cuid())
  name        SubscriptionPlan @unique // FREE, BASIC, PRO, ENTERPRISE (enum)
  displayName String
  description String?
  price       Float            @default(0) // Monthly price in VND
  features    Json // Feature flags: {pos: true, ai: true, reports: true, ...}
  limits      Json // Limits: {staff: 10, bookings: 1000, customers: 5000, ...}
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  subscriptions Subscription[]
  Salon         Salon[]

  @@index([isActive])
}

model Subscription {
  id                  String             @id @default(cuid())
  salonId             String             @unique
  planId              String
  status              SubscriptionStatus @default(TRIAL)
  trialEndsAt         DateTime?
  currentPeriodStart  DateTime           @default(now())
  currentPeriodEndsAt DateTime?
  cancelledAt         DateTime?
  cancelReason        String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  salon   Salon                 @relation(fields: [salonId], references: [id], onDelete: Cascade)
  plan    Plan                  @relation(fields: [planId], references: [id])
  history SubscriptionHistory[]

  @@index([salonId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEndsAt])
}

model SubscriptionHistory {
  id             String   @id @default(cuid())
  subscriptionId String
  action         String // UPGRADE, DOWNGRADE, RENEW, CANCEL, REACTIVATE
  fromPlanId     String?
  toPlanId       String
  reason         String?
  metadata       Json? // Additional info
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([action])
  @@index([createdAt])
}

model UsageTracking {
  id        String   @id @default(cuid())
  salonId   String
  period    String // YYYYMM format (e.g., "202401")
  metric    String // bookings, invoices, customers, staff
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  salon Salon @relation(fields: [salonId], references: [id], onDelete: Cascade)

  @@unique([salonId, period, metric])
  @@index([salonId])
  @@index([period])
  @@index([metric])
}
